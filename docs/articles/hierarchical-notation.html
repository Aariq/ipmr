<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hierarchical Notation • ipmr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Hierarchical Notation">
<meta property="og:description" content="ipmr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ipmr</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    <li class="dropdown-header">Introduction to ipmr</li>
    <li>
      <a href="../articles/ipmr-introduction.html">Introduction to ipmr</a>
    </li>
    <li>
      <a href="../articles/general-ipms.html">General IPMs</a>
    </li>
    <li>
      <a href="../articles/hierarchical-notation.html">Hierarchical Notation</a>
    </li>
    <li>
      <a href="../articles/age_x_size.html">Age-Size IPMs</a>
    </li>
    <li>
      <a href="../articles/density-dependence.html">Density Dependent IPMs</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Generic Functions</li>
    <li>
      <a href="../articles/generic-funs.html">List of Generic and Helper Functions in ipmr</a>
    </li>
    <li>
      <a href="../articles/generic-progress.html">Generic Progress</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">proto_ipm Overview</li>
    <li>
      <a href="../articles/proto-ipms.html">proto_ipm Data Structure</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">ipmr Checks</li>
    <li>
      <a href="../articles/sanity-checks.html">Sanity checks for ipmr examples</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Hierarchical Notation</h1>
            
      
      
      <div class="hidden name"><code>hierarchical-notation.Rmd</code></div>

    </div>

    
    
<p>This vignette describes how to write formulas using <code>ipmr</code>’s notation for hierarchical models. It is meant to mirror the standard mathematical notation used to represent the models. The examples here will primarily use <a href="https://github.com/lme4/lme4/">lme4</a> to illustrate how to go from vital rate models to functional forms that you can use in <code>ipmr</code>. You are of course free to use whatever model fitting software you like, but the number of different possibilities are far too great to cover in this vignette.</p>
<p>The <code>ipmr</code> notation is meant to make implementing models more concise, as it allows you to avoid re-typing/copy+pasting the same kernel formats and just substituting, for example, plot name or transition year. It works by appending suffixes to kernels, vital rates, and parameters that can take multiple values (e.g. <code>P</code> becomes <code>P_yr</code>). We then add a named list where the names correspond to the suffix and the entries correspond to the values it can take and pass it to <code>levels_hier_effs</code> (i.e. <code>levels_hier_effs = list(yr = 1:5)</code>), and set <code>has_hier_effs = TRUE</code>.</p>
<div id="structure" class="section level2">
<h2 class="hasAnchor">
<a href="#structure" class="anchor"></a>Structure</h2>
<ol style="list-style-type: decimal">
<li><p><a href="#quick">Quick start guide shows how to go from mathematical form to model formula to <code>ipmr</code> code.</a></p></li>
<li><p><a href="#sim_di_s_k">Worked example with a simple, density independent, stochastic kernel re-sampled model.</a></p></li>
<li><p><a href="#complicated">Worked example with a general, density independent, stochastic parameter resampled model.</a></p></li>
</ol>
</div>
<div id="quick" class="section level2">
<h2 class="hasAnchor">
<a href="#quick" class="anchor"></a>Quick start guide</h2>
<p>Some quick translations between mathematical notation, R model syntax, and <code>ipmr</code> style notation. In the <code>ipmr</code> column, suffixes that are appended are highlighted in <strong>bold</strong>.</p>
<p>Suffix names are not restricted to the examples below. The only requirement is that the suffix not be named <code>"pop"</code>. This is an unfortunate side effect of the way <code>ipmr</code> handles population vectors internally - please use something like <code>"site"</code> or <code>"population"</code> instead.</p>
<div id="notation-guide" class="section level3">
<h3 class="hasAnchor">
<a href="#notation-guide" class="anchor"></a>Notation guide</h3>
<p>The mathematical notation in this vignette will take the following form:</p>
<p>Coefficients/parameters: <span class="math inline">\(\alpha\)</span> - intercept, <span class="math inline">\(\beta\)</span> - slope, <span class="math inline">\(\mu\)</span> - mean, <span class="math inline">\(\sigma\)</span> standard deviation.</p>
<p>Vital rates: subscripts on the coefficients/parameters. For example, <span class="math inline">\(\alpha_g\)</span> for the intercept of a growth model.</p>
<p>Hierarchical effects: superscripts on coefficients. For example, <span class="math inline">\(\beta_g^{site}\)</span> for a site specific growth slope.</p>
<table class="table">
<caption>
Math Formula corresponds to the mathematical notation for the model. R Formula corresponds to how one could write the model using R’s model formula syntax (think <code>lm</code>, <code>glm</code>, <code>lmer</code>). ipmr shows an equivalent way to write this model in kernel formula or vital rate expression. Model Number indicates which rows are grouped together, as some models have too many terms to cleanly fit on a line, or have multiple equivalent representations.
</caption>
<thead><tr>
<th style="text-align:left;">
Math Formula
</th>
<th style="text-align:left;">
R Formula
</th>
<th style="text-align:left;">
ipmr
</th>
<th style="text-align:right;">
Model Number
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
<span class="math inline">\(\mu_g^{yr} = \alpha_g + \alpha_g^{yr} * \beta_g * z\)</span>
</td>
<td style="text-align:left;">
<code>size_2 ~ size_1 + (1 | year), family = gaussian()</code>
</td>
<td style="text-align:left;">
mu_g_<strong>yr</strong> = g_int + g_int_<strong>yr</strong> + g_slope * z
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
<span class="math inline">\(z' \sim Norm(\mu_g^{yr}, \sigma_g)\)</span>
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
g = dnorm(z_2, mu_g_<strong>yr</strong>, sd_g)
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
<span class="math inline">\(Logit(\mu_{s}^{plot,yr}) = \alpha_s + \alpha_{s}^{plot,yr} + \beta * z\)</span>
</td>
<td style="text-align:left;">
<code>surv ~ size_1 + (1 | year) + (1 | plot), family = binomial()</code>
</td>
<td style="text-align:left;">
s_<strong>pl</strong>_<strong>yr</strong> = s_int + s_int_<strong>pl</strong>_<strong>yr</strong> + s_slope * z
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
<code>surv ~ size_1 + (1 | year) + (1 | plot), family = binomial()</code>
</td>
<td style="text-align:left;">
s_<strong>pl</strong>_<strong>yr</strong> = s_int + s_int_<strong>pl</strong> + s_int_<strong>yr</strong> + s_slope * z
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
s = inv_logit(s_<strong>pl</strong>_<strong>yr</strong>)
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
<span class="math inline">\(log(\mu_f^{yr}) = \alpha_{f} + \alpha_f^{yr} + (\beta_f + \beta_f^{yr}) * z\)</span>
</td>
<td style="text-align:left;">
<code>fec ~ size_1 + (size_1 | year), family = poisson()</code>
</td>
<td style="text-align:left;">
fec = exp(f_int + f_int_<strong>yr</strong> + (f_slope + f_slope_<strong>yr</strong>) * z)
</td>
<td style="text-align:right;">
3
</td>
</tr>
</tbody>
</table>
<p>Internally, <code>ipmr</code> generates the various levels using <code>expand.grid</code>. This means that every combination of the values in <code>levels_hier_effs</code> must exist in the <code>data_list</code>, or the model will fail with an error along the lines of (<code>Error in eval_tidy: object 'x_yz' not found</code>). In order to exclude levels that do not exist in your data, you can add a vector to the list in <code>levels_hier_effs</code> called <code>drop_levels</code>. This should contain the values you wish to exclude as a character vector. For example, if data are collected for <code>sites = c("a", "b", "c")</code>, and <code>years = c(2005:2008)</code>, but there is no data from site <code>"a"</code> in 2007, we can use <code>levels_hier_effs = list(site = c("a", "b", "c"), year = c(2005:2008), drop_levels = c("a_2007"))</code>.</p>
</div>
</div>
<div id="sim_di_s_k" class="section level2">
<h2 class="hasAnchor">
<a href="#sim_di_s_k" class="anchor"></a>Hierarchical models with a single hierarchical variable</h2>
<p>These models are pretty common in the IPM literature. They encompass cases where a single site has been sampled over many years, or sample many sites across one transition.</p>
<p>This example will use a hypothetical study that spans 5 transitions and has 6 consecutive censuses. The temporal variation will be denoted with a suffix/superscript appended to each term that it modifies (<span class="math inline">\(x^{yr}\)</span>/<code>x_yr</code>). To limit complexity, let’s pretend our exploratory analysis and model selection indicated the best overall models included random year-specifc intercepts for growth (<span class="math inline">\(g^{yr}\)</span>) and survival (<span class="math inline">\(s^{yr}\)</span>), but not probability of reproduction (<span class="math inline">\(f_p\)</span>), recruit production (<span class="math inline">\(f_r\)</span>), or the recruit size distribution (<span class="math inline">\(f_d\)</span>). We will work with a simple model to start (i.e. 1 continuous state variable, no discrete states). This yields the following IPM (<span class="math inline">\(z,z'\)</span> represent size/height/weight at time <span class="math inline">\(t\)</span> and <span class="math inline">\(t+1\)</span>, respectively):</p>
<ol style="list-style-type: decimal">
<li><p><span class="math inline">\(K^{yr}(z', z) = P^{yr}(z',z) + F(z',z)\)</span></p></li>
<li><p><span class="math inline">\(P^{yr}(z', z) = s^{yr}(z) * g^{yr}(z',z)\)</span></p></li>
<li><p><span class="math inline">\(F(z',z) = f_p(z) + f_r(z) + f_d(z')\)</span></p></li>
</ol>
<p>Note that only the <span class="math inline">\(K\)</span> and <span class="math inline">\(P\)</span> kernels get the <span class="math inline">\(yr\)</span> subscript appended to them - they are the only ones that our model selection process decided had substantial year to year variation. Thus, we can actually write the <span class="math inline">\(F\)</span> kernel the exact same way as we would in a simple IPM when we implement the model in <code>ipmr</code>.</p>
<p>The vital rate models could be written on paper as follows:</p>
<ol start="4" style="list-style-type: decimal">
<li>
<p>Growth</p>
<ul>
<li><p><span class="math inline">\(\mu_g = (\alpha_g + \alpha_g^{yr})+ \beta_g * z + e\)</span></p></li>
<li><p><span class="math inline">\(z' \sim Norm(\mu_g, \sigma_g)\)</span> (where <span class="math inline">\(\sigma_g\)</span> = e in the <span class="math inline">\(\mu_g\)</span> expression)</p></li>
</ul>
</li>
<li>
<p>Survival</p>
<ul>
<li><span class="math inline">\(logit(s) = (\alpha_s + \alpha_s^{yr}) + \beta_s * z\)</span></li>
</ul>
</li>
<li>
<p>Probability of reproducing</p>
<ul>
<li><span class="math inline">\(logit(f_p) = \alpha_{f_p} + \beta_{f_p} * z\)</span></li>
</ul>
</li>
<li>
<p>Recruit production</p>
<ul>
<li><span class="math inline">\(log(f_r) = \alpha_{f_r} + \beta_{f_r} * z\)</span></li>
</ul>
</li>
<li>
<p>Recruit size distribution</p>
<ul>
<li><span class="math inline">\(f_d \sim Norm(\mu_{f_d}, \sigma_{f_d})\)</span></li>
</ul>
</li>
</ol>
<p>and modelled in R as follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/lme4/lme4">lme4</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">ipmr</span>)

<span class="kw">grow_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span>(<span class="kw">size_2</span> <span class="op">~</span> <span class="kw">size_1</span> <span class="op">+</span> (<span class="fl">1</span> <span class="op">|</span> <span class="kw">year</span>), data = <span class="kw">grow_data</span>)

<span class="kw">surv_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span>(<span class="kw">surv</span> <span class="op">~</span> <span class="kw">size_1</span> <span class="op">+</span> (<span class="fl">1</span> <span class="op">|</span> <span class="kw">year</span>), data = <span class="kw">surv_data</span>, family = <span class="kw">binomial</span>)

<span class="kw">repr_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(<span class="kw">repr</span> <span class="op">~</span> <span class="kw">size_1</span>, data = <span class="kw">repr_data</span>, family = <span class="kw">binomial</span>)

<span class="kw">recr_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span>(<span class="kw">recr</span> <span class="op">~</span> <span class="kw">size_1</span>, data = <span class="kw">recr_data</span>, family = <span class="kw">poisson</span>)

<span class="kw">rcsz_mu</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw">rcsz_data</span><span class="op">$</span><span class="kw">size_2</span>)
<span class="kw">rcsz_sd</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span>(<span class="kw">rcsz_data</span><span class="op">$</span><span class="kw">size_2</span>)
</pre></div>
<p>We could then extract the fixed coefficients with the <code>fixef</code> method and the conditional modes of the random effects via the <code>ranef</code> method:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">beta_gs</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/fixef.html">fixef</a></span>(<span class="kw">grow_mod</span>)

<span class="kw">alpha_g_yrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/ranef.html">ranef</a></span>(<span class="kw">grow_mod</span>)

<span class="kw">beta_ss</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/fixef.html">fixef</a></span>(<span class="kw">surv_mod</span>)

<span class="kw">alpha_s_yrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/ranef.html">ranef</a></span>(<span class="kw">surv_mod</span>)
</pre></div>
<p>The non-mixed models can use the <code>coef</code> method to extract a vector of coefficients:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw">repr_coef</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="kw">repr_mod</span>)

<span class="kw">recr_coef</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="kw">recr_mod</span>)
</pre></div>
<p>The next step is to transform these values into something <code>ipmr</code> can use. This must always be a <strong>named list</strong> where the names of the list components are the names used in the vital expressions or kernel formula. Transforming the <span class="math inline">\(\beta\)</span>s is easier - the output from fixef is always a named vector, so we just use <code><a href="https://rdrr.io/r/base/list.html">as.list()</a></code> and change the names to whatever we want to use. We then bundle it into one big list with all the fixed coefficients.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">g_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="kw">beta_gs</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">g_list</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha_g"</span>, <span class="st">"beta_g"</span>)

<span class="kw">s_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="kw">beta_ss</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">s_list</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha_s"</span>, <span class="st">"beta_s"</span>)

<span class="kw">f_p_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="kw">recr_coef</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">f_p_list</span> ) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha_f_p"</span>, <span class="st">"beta_f_p"</span>)

<span class="kw">f_r_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="kw">repr_coef</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">f_r_list</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha_f_r"</span>, <span class="st">"beta_f_r"</span>)

<span class="kw">f_d_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(mu_f_d = <span class="kw">rcsz_mu</span>, sigma_f_d = <span class="kw">rcsz_sd</span>)

<span class="kw">all_fixed_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">g_list</span>, <span class="kw">s_list</span>, <span class="kw">f_p_list</span>, <span class="kw">f_r_list</span>, <span class="kw">f_d_list</span>)
</pre></div>
<p>For the random effects, we probably need to do some a bit more processing, though this really depends on which modelling framework you use and the format of the outputs. For <code>lme4</code>, it looks like this:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="kw">g_alpha_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="kw">alpha_g_yrs</span>))
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">g_alpha_list</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"alpha_g_"</span>, <span class="fl">2001</span><span class="op">:</span><span class="fl">2006</span>, sep = <span class="st">""</span>)

<span class="kw">s_alpha_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="kw">alpha_s_yrs</span>))
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">s_alpha_list</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"alpha_s_"</span>, <span class="fl">2001</span><span class="op">:</span><span class="fl">2006</span>, sep = <span class="st">""</span>)
</pre></div>
<p>First, we strip away all of <code>lme4</code>-related attributes with <code><a href="https://rdrr.io/r/base/unlist.html">unlist()</a></code>, then convert it to the flat list format that we need. Next, we set the names. Now, we can combine it with our <code>all_fixed_params</code> list and we have all of the parameters we need for the kernel functions:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="kw">all_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">all_fixed_params</span>, <span class="kw">g_alpha_list</span>, <span class="kw">s_alpha_list</span>)
</pre></div>
<p>We are now ready to begin implementing the kernels! This model will be a simple, density independent, stochastic kernel-resampled model (<code>"simple_di_stoch_kern"</code> class). The parts where the hierarchical syntax is used are highlighted by comments in the code block:</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw">ex_ipm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init_ipm.html">init_ipm</a></span>(<span class="st">"simple_di_stoch_kern"</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span>(
    
    <span class="co"># _yr is appended as a suffix with an underscore. Notice how the formula</span>
    <span class="co"># from 2 is translated into the formula argument and the kernel name</span>
    
    name             = <span class="st">"P_yr"</span>,
    family           = <span class="st">"CC"</span>,
    formula          = <span class="kw">s_yr</span> <span class="op">*</span> <span class="kw">g_yr</span>,
    
    <span class="co"># We also modify each parameter name with a suffix as well.</span>
    <span class="co"># Here, I've split out the linear predictor and the inverse logit</span>
    <span class="co"># transformation into separate steps to avoid over cluttering</span>
    
    s_lin_p          = <span class="kw">alpha_s</span> <span class="op">+</span> <span class="kw">alpha_s_yr</span> <span class="op">+</span> <span class="kw">beta_s</span> <span class="op">*</span> <span class="kw">z_1</span>,
    s_yr             = <span class="fl">1</span> <span class="op">/</span> (<span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="op">-</span> <span class="kw">s_lin_p</span>)),
    
    <span class="co"># We do the same with growth as we did with survival and the P_yr formula</span>
    
    g_yr             = <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(<span class="kw">z_2</span>, <span class="kw">mu_g_yr</span>, <span class="kw">sigma_g</span>),
    mu_g_yr          = <span class="kw">alpha_g</span> <span class="op">+</span> <span class="kw">alpha_g_yr</span> <span class="op">+</span> <span class="kw">beta_g</span> <span class="op">*</span> <span class="kw">z_1</span>,
    
    data_list        = <span class="kw">all_params</span>,
    states           = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"z"</span>)),
    
    <span class="co"># We signal that the kernel has hierarchical effects</span>
    
    has_hier_effs    = <span class="fl">TRUE</span>,
    
    <span class="co"># And provide the values that each suffix can take as a named list. </span>
    <span class="co"># The name(s) in this list MUST match the suffix used in the expressions.</span>
    
    levels_hier_effs = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(yr = <span class="fl">2001</span><span class="op">:</span><span class="fl">2006</span>),
    evict_cor        = <span class="fl">TRUE</span>,
    evict_fun        = <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span>(<span class="st">"norm"</span>, <span class="st">"g_yr"</span>)
  ) <span class="op">%&gt;%</span>
  
  <span class="co"># This kernel doesn't get anything special because there are no</span>
  <span class="co"># time-varying parameter values.</span>
  
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span>(
    name          = <span class="st">"F"</span>,
    family        = <span class="st">"CC"</span>,
    formula       = <span class="kw">f_p</span> <span class="op">*</span> <span class="kw">f_r</span> <span class="op">*</span> <span class="kw">f_d</span>,
    f_p_lin_p     = <span class="kw">alpha_f_p</span> <span class="op">+</span> <span class="kw">beta_f_p</span> <span class="op">*</span> <span class="kw">z_1</span>,
    f_p           = <span class="fl">1</span> <span class="op">/</span> (<span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>( <span class="op">-</span><span class="kw">f_p_lin_p</span>)),
    f_r           = <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">alpha_f_r</span> <span class="op">+</span> <span class="kw">beta_f_r</span> <span class="op">*</span> <span class="kw">z_1</span>),
    f_d           = <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(<span class="kw">z_2</span>, <span class="kw">mu_f_d</span>, <span class="kw">sigma_f_d</span>),
    data_list     = <span class="kw">all_params</span>,
    states        = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"z"</span>)),
    has_hier_effs = <span class="fl">FALSE</span>,
    evict_cor     = <span class="fl">TRUE</span>,
    evict_fun     = <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span>(<span class="st">"norm"</span>, <span class="st">"f_d"</span>)
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_k</a></span>(
    
    <span class="co"># name is modified to indicate that the K's will vary from year to year</span>
    
    name             = <span class="st">"K_yr"</span>,
    family           = <span class="st">"IPM"</span>,
    
    <span class="co"># the formulas are modified to indicate that they will also</span>
    <span class="co"># vary from year to year</span>
    
    K_yr             = <span class="kw">P_yr</span> <span class="op">+</span> <span class="kw">F</span>,
    n_z_t_1          = <span class="kw">K_yr</span> <span class="op">%*%</span> <span class="kw">n_z_t</span>,
    states           = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"z"</span>)),
    has_hier_effs    = <span class="fl">TRUE</span>,
    levels_hier_effs = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(yr = <span class="fl">2001</span><span class="op">:</span><span class="fl">2006</span>),
    evict_cor        = <span class="fl">FALSE</span>
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_impl</a></span>(
    <span class="fu"><a href="../reference/define_impl.html">make_impl_args_list</a></span>(
      kernel_names = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"P_yr"</span>, <span class="st">"F"</span>, <span class="st">"K_yr"</span>),
      int_rule     = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"midpoint"</span>, <span class="fl">3</span>),
      dom_start    = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"z"</span>, <span class="fl">3</span>),
      dom_end      = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"z"</span>, <span class="fl">3</span>)
    )
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_domains</a></span>(
    z = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.1</span>, <span class="fl">10</span>, <span class="fl">50</span>)
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_pop_state</a></span>(
    n_z = <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">50</span>)
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/make_ipm.html">make_ipm</a></span>(
    iterate    = <span class="fl">TRUE</span>,
    iterations = <span class="fl">100</span>,
    kernel_seq = <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">2001</span><span class="op">:</span><span class="fl">2006</span>, size = <span class="fl">100</span>, replace = <span class="fl">TRUE</span>),
    normalize_pop_size = <span class="fl">TRUE</span>
  )
</pre></div>
</div>
<div id="complicated" class="section level2">
<h2 class="hasAnchor">
<a href="#complicated" class="anchor"></a>Hierarchical models with continuously varying environments</h2>
<p>Sometimes, models will have discretely and continuously varying components as functions of different variables. For example, a study could consider multiple sites (discrete component) and spatial and/or temporal fluctations in environment at each site (continuous component).</p>
<p>In these cases, the hierarchical syntax can save a considerable amount of repitition when implementing a model arising from either copy + pasting code and changing variable names to match sites/years, or from wrapping everything in a <code>for</code> loop. We’ll use a hypothetical study that models demography as a function of environment across multiple sites to illustrate this.</p>
<p>We’ll implement a general IPM of a perennial plant species. Our data will come from 6 sites, <code>"A"</code> - <code>"F"</code>, and the vital rate intercepts for the plants will vary across each one. Its seeds can either enter a seed bank or recruit immediately, producing recruits at the next time step. We’ll pretend that data from the recruit size distribution was pooled across sites so that the seed bank-related terms are unchanged by space. The seed bank will be age structured and its parameters will be space- and time-invariant. Seeds in the first year can either survive (<span class="math inline">\(s_{{sb}_1}\)</span>/<code>s_sb1</code>) and recruit (<span class="math inline">\(r_{{sb}_1}\)</span>), or survive and become two year old seeds. Two year old seeds can either survive (<span class="math inline">\(s_{{sb}_2}\)</span>/<code>s_sb2</code>) and recruit (<span class="math inline">\(r_{{sb}_2}\)</span>/<code>r_sb2</code>) or die.</p>
<p>The vital rate information fed into our hypothetical regression models are (<span class="math inline">\(s^{site}\)</span>/<code>s_site</code>), growth (<span class="math inline">\(g^{site}\)</span>/<code>g_site</code>), probability of reproduction (<span class="math inline">\(f_{p}^{site}\)</span>/<code>f_p_site</code>), and seed production (<span class="math inline">\(f_{r}^{site}\)</span>/<code>f_r_site</code>). They are all functions of size (<code>z</code>) and environmental covariates (<span class="math inline">\(\theta^{temp}\)</span> and <span class="math inline">\(\theta^{precip}\)</span>, denoted together in the kernel formulas as just <span class="math inline">\(\theta\)</span>).</p>
<p>The full IPM looks like this:</p>
<ol style="list-style-type: decimal">
<li><p><span class="math inline">\(n(z, t + 1) = \int_L^U [P^{site}(z', z,\theta) + r_i * F^{site}(z', z, \theta)]n(z, t)\mathrm{dz} + \int_L^Us_{{sb}_1} * r_{{sb}_1} * f_d(z')n(sb_1, t)\mathrm{dz} + \int_L^Us_{{sb}_2} * r_{{sb}_2} * f_d(z')n(sb_2, t)\mathrm{dz}\)</span></p></li>
<li><p><span class="math inline">\(n(sb_1, t + 1) = (1-r_i) * \int_L^U [f_p^{site}(z, \theta) * f_r^{site}(z,\theta)] n(z, t)\mathrm{dz}\)</span></p></li>
<li><p><span class="math inline">\(n(sb_2, t + 1) = s_{{sb}_1} * (1-r_{{sb}_1}) * n(sb_1, t)\)</span></p></li>
</ol>
<p>The sub kernels are:</p>
<ol start="4" style="list-style-type: decimal">
<li><p><span class="math inline">\(P^{site}(z',z, \theta) = s^{site}(z, \theta) * g^{site}(z',z, \theta)\)</span></p></li>
<li><p><span class="math inline">\(F^{site}(z',z, \theta) = f_{{p}}^{site}(z, \theta) * f_{r}^{site}(z, \theta) * f_d(z')\)</span></p></li>
<li><p><span class="math inline">\(\theta^{temp} \sim Norm(mean^{temp}, SD^{temp})\)</span></p></li>
<li><p><span class="math inline">\(\theta^{precip} \sim Gamma(shape^{precip}, rate^{precip})\)</span></p></li>
</ol>
<p>And the size/climate dependent vital rate functions and example R code are:</p>
<ol start="8" style="list-style-type: decimal">
<li><span class="math inline">\(logit(s^{site}) = (\alpha_s + \alpha_{s}^{site}) + \beta_s^{z} * z + \beta_s^{temp} * \theta^{temp} + \beta_s^{precip} * \theta^{precip}\)</span></li>
</ol>
<ul>
<li>example R code: <code><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer(survival ~ size + temp + precip + (1 | site), data = my_surv_data, family = binomial())</a></code>
</li>
</ul>
<ol start="9" style="list-style-type: decimal">
<li><p><span class="math inline">\(g^{site} \sim Norm(\mu_g^{site}, \sigma_g)\)</span></p></li>
<li><p><span class="math inline">\(\mu_g^{site} = (\alpha_g + \alpha_g^{site}) + \beta_g^{z} * z + \beta_g^{temp} * \theta^{temp} + \beta_g^{precip} * \theta^{precip}\)</span></p></li>
</ol>
<ul>
<li>example R code: <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer(size_next ~ size + temp + precip + (1 | site), data = my_grow_data)</a></code>
</li>
</ul>
<ol start="11" style="list-style-type: decimal">
<li><span class="math inline">\(logit(f_{p}^{site}) = (\alpha_{f_p} + \alpha_{f_p}^{site}) + \beta_{f_p}^{z} * z + \beta_{f_p}^{temp} * \theta^{temp} + \beta_{f_p}^{precip} * \theta^{precip}\)</span></li>
</ol>
<ul>
<li>example R code: <code><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer(repro ~ size + temp + precip + (1 | site), data = my_repro_data, family = binomial())</a></code>
</li>
</ul>
<ol start="12" style="list-style-type: decimal">
<li><span class="math inline">\(log(f_{r}^{site}) = (\alpha_{f_r} + \alpha_{f_r}^{site}) + \beta_{f_r}^{site} * z + \beta_{f_r}^{temp} * \theta_{temp} + \beta_{f_r}^{precip} * \theta_{precip}\)</span></li>
</ol>
<ul>
<li>example R code: <code><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer(flower_n ~ size + temp + precip + (1 | site), data = my_flower_data, family = poisson())</a></code>
</li>
</ul>
<ol start="13" style="list-style-type: decimal">
<li><span class="math inline">\(f_d \sim Norm(\mu_{f_d}, \sigma_{f_d})\)</span></li>
</ol>
<ul>
<li>example R code: <code><a href="https://rdrr.io/r/base/mean.html">mean(my_recr_data$size_next); sd(my_recr_data$size_next)</a></code>
</li>
</ul>
<div id="simulating-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#simulating-parameters" class="anchor"></a>Simulating parameters</h3>
<p>We have to simulate some parameters for each site. Additionally, we’ll specify the distribution parameters for each <span class="math inline">\(\theta\)</span> and write a function that samples them once.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">ipmr</span>)

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">51</span>)

<span class="co"># Set up the sites, and the parameters</span>

<span class="kw">sites</span> <span class="op">&lt;-</span> <span class="kw">LETTERS</span>[<span class="fl">1</span><span class="op">:</span><span class="fl">6</span>]

<span class="kw">all_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  r_i       = <span class="fl">0.6</span>,
  r_sb1     = <span class="fl">0.2</span>,
  r_sb2     = <span class="fl">0.3</span>,
  s_sb1     = <span class="fl">0.4</span>,
  s_sb2     = <span class="fl">0.1</span>,
  mu_f_d    = <span class="fl">4</span>,
  sigma_f_d = <span class="fl">0.9</span>,
  sigma_g   = <span class="fl">3</span>, 
  beta_s_prec = <span class="fl">0.3</span>,
  beta_s_temp = <span class="op">-</span><span class="fl">0.5</span>,
  beta_g_prec = <span class="fl">0.01</span>,
  beta_g_temp = <span class="fl">0.1</span>,
  beta_f_p_prec = <span class="fl">0.6</span>,
  beta_f_p_temp = <span class="op">-</span><span class="fl">0.3</span>,
  beta_f_r_prec = <span class="op">-</span><span class="fl">0.3</span>,
  beta_f_r_temp = <span class="fl">0.9</span>
)

<span class="kw">g_alphs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">6</span>, mean = <span class="fl">4.5</span>, sd = <span class="fl">1</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>() <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">'alpha_g_'</span>, <span class="kw">sites</span>, sep = <span class="st">""</span>)
  )

<span class="kw">g_betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">6</span>, <span class="fl">0.85</span>, <span class="fl">1.15</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>() <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">'beta_g_'</span>, <span class="kw">sites</span>, sep = <span class="st">""</span>)
  )

<span class="kw">s_alphs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">6</span>, mean = <span class="op">-</span><span class="fl">7</span>, sd = <span class="fl">1.5</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>() <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">'alpha_s_'</span>, <span class="kw">sites</span>, sep = <span class="st">""</span>)
  )
<span class="kw">s_betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">6</span>, <span class="fl">2</span>, <span class="fl">3</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>() <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">'beta_s_'</span>, <span class="kw">sites</span>, sep = <span class="st">""</span>)
  )

<span class="kw">f_p_alphs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">6</span>, mean = <span class="op">-</span><span class="fl">10</span>, sd = <span class="fl">2</span>)  <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>() <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">'alpha_f_p_'</span>, <span class="kw">sites</span>, sep = <span class="st">""</span>)
  )
<span class="kw">f_p_betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">6</span>, <span class="fl">0.3</span>, <span class="fl">1</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>() <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">'beta_f_p_'</span>, <span class="kw">sites</span>, sep = <span class="st">""</span>)
  )

<span class="kw">f_r_alphs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">6</span>, <span class="fl">0.01</span>, <span class="fl">0.1</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>() <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">'alpha_f_r_'</span>, <span class="kw">sites</span>, sep = <span class="st">""</span>)
  )
<span class="kw">f_r_betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">6</span>, <span class="fl">0.0001</span>, <span class="fl">0.01</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>() <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">'beta_f_r_'</span>, <span class="kw">sites</span>, sep = <span class="st">""</span>)
  ) 

<span class="kw">all_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">all_pars</span>,
              <span class="kw">g_alphs</span>, <span class="kw">g_betas</span>,
              <span class="kw">s_alphs</span>, <span class="kw">s_betas</span>,
              <span class="kw">f_p_alphs</span>, <span class="kw">f_p_betas</span>,
              <span class="kw">f_r_alphs</span>, <span class="kw">f_r_betas</span>)

<span class="co"># This list contains parameters that define the distributions for environmental</span>
<span class="co"># covariates</span>

<span class="kw">env_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  temp_mu = <span class="fl">12</span>,
  temp_sd = <span class="fl">2</span>,
  prec_shape = <span class="fl">1000</span>,
  prec_rate  = <span class="fl">2</span>
)

<span class="co"># This function samples the environmental covariate distributions and returns</span>
<span class="co"># the values in a named list. We can reference the names in the list in our</span>
<span class="co"># vital rate expressions.</span>

<span class="kw">sample_fun</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">env_params</span>) {
  
  <span class="kw">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">1</span>, <span class="kw">env_params</span><span class="op">$</span><span class="kw">temp_mu</span>, <span class="kw">env_params</span><span class="op">$</span><span class="kw">temp_sd</span>)
  
  <span class="kw">prec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span>(<span class="fl">1</span>, <span class="kw">env_params</span><span class="op">$</span><span class="kw">prec_shape</span>, <span class="kw">env_params</span><span class="op">$</span><span class="kw">prec_rate</span>)
  
  <span class="kw">out</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(temp = <span class="kw">temp</span>,
               prec = <span class="kw">prec</span>)
  
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw">out</span>)
  
}
</pre></div>
</div>
<div id="implementing-the-model" class="section level3">
<h3 class="hasAnchor">
<a href="#implementing-the-model" class="anchor"></a>Implementing the model</h3>
<p>We’ve written out our model - now we can implement it! We’ll use the general, density independent, stochastic parameter resampled machinery for this.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="kw">ex_ipm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init_ipm.html">init_ipm</a></span>(<span class="st">"general_di_stoch_param"</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span>(
    
    name = <span class="st">"P_site"</span>,
    family = <span class="st">"CC"</span>,
    
    <span class="co"># site is appended so that we don't have to write out s_a, s_b, etc.</span>
    
    formula          = <span class="kw">s_site</span> <span class="op">*</span> <span class="kw">g_site</span> <span class="op">*</span> <span class="kw">d_z</span>,
    
    s_site_lin       = <span class="kw">alpha_s_site</span> <span class="op">+</span> <span class="kw">beta_s_site</span> <span class="op">*</span> <span class="kw">z_1</span> <span class="op">+</span> <span class="kw">beta_s_prec</span> <span class="op">*</span> <span class="kw">prec</span> <span class="op">+</span> <span class="kw">beta_s_temp</span> <span class="op">*</span> <span class="kw">temp</span>,
    s_site           = <span class="fl">1</span> <span class="op">/</span> (<span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="op">-</span><span class="kw">s_site_lin</span>)),
    mu_g_site        = <span class="kw">alpha_g_site</span> <span class="op">+</span> <span class="kw">beta_g_site</span> <span class="op">*</span> <span class="kw">z_1</span> <span class="op">+</span> <span class="kw">beta_g_prec</span> <span class="op">*</span> <span class="kw">prec</span> <span class="op">+</span> <span class="kw">beta_g_temp</span> <span class="op">*</span> <span class="kw">temp</span>,
    g_site           = <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(<span class="kw">z_2</span>, <span class="kw">mu_g_site</span>, <span class="kw">sigma_g</span>),
    data_list        = <span class="kw">all_pars</span>,
    states           = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"z"</span>)),
    has_hier_effs    = <span class="fl">TRUE</span>,
    levels_hier_effs = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(site = <span class="kw">LETTERS</span>[<span class="fl">1</span><span class="op">:</span><span class="fl">6</span>]),
    evict_cor        = <span class="fl">TRUE</span>,
    evict_fun        = <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span>(<span class="st">"norm"</span>, <span class="st">"g_site"</span>)
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span>(
    name             = <span class="st">"F_site"</span>,
    family           = <span class="st">"CC"</span>,
    formula          = <span class="kw">f_p_site</span> <span class="op">*</span> <span class="kw">f_r_site</span> <span class="op">*</span> <span class="kw">f_d</span> <span class="op">*</span> <span class="kw">d_z</span>,
    f_p_site_lin     = <span class="kw">alpha_f_p_site</span> <span class="op">+</span> <span class="kw">beta_f_p_site</span> <span class="op">*</span> <span class="kw">z_1</span> <span class="op">+</span> <span class="kw">beta_f_p_prec</span> <span class="op">*</span> <span class="kw">prec</span> <span class="op">+</span> <span class="kw">beta_f_p_temp</span> <span class="op">*</span> <span class="kw">temp</span>,
    f_p_site         = <span class="fl">1</span> <span class="op">/</span> (<span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="op">-</span><span class="kw">f_p_site_lin</span>)),
    f_r_site         = <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">alpha_f_r_site</span> <span class="op">+</span> <span class="kw">beta_f_r_site</span> <span class="op">*</span> <span class="kw">z_1</span> <span class="op">+</span> <span class="kw">beta_f_r_prec</span> <span class="op">*</span> <span class="kw">prec</span> <span class="op">+</span> <span class="kw">beta_f_r_temp</span> <span class="op">*</span> <span class="kw">temp</span>),
    f_d              = <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(<span class="kw">z_2</span>, <span class="kw">mu_f_d</span>, <span class="kw">sigma_f_d</span>),
    data_list        = <span class="kw">all_pars</span>,
    states           = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"z"</span>)),
    has_hier_effs    = <span class="fl">TRUE</span>,
    levels_hier_effs = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(site = <span class="kw">LETTERS</span>[<span class="fl">1</span><span class="op">:</span><span class="fl">6</span>]),
    evict_cor        = <span class="fl">TRUE</span>,
    evict_fun        = <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span>(<span class="st">"norm"</span>, <span class="st">"f_d"</span>)
    ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span>(
    name             = <span class="st">"go_sb_1_site"</span>,
    family           = <span class="st">"CD"</span>,
    formula          = (<span class="fl">1</span> <span class="op">-</span> <span class="kw">r_i</span>) <span class="op">*</span> <span class="kw">f_p_site</span> <span class="op">*</span> <span class="kw">f_r_site</span> <span class="op">*</span> <span class="kw">d_z</span>,
    f_p_site_lin     = <span class="kw">alpha_f_p_site</span> <span class="op">+</span> <span class="kw">beta_f_p_site</span> <span class="op">*</span> <span class="kw">z_1</span> <span class="op">+</span> <span class="kw">beta_f_p_prec</span> <span class="op">*</span> <span class="kw">prec</span> <span class="op">+</span> <span class="kw">beta_f_p_temp</span> <span class="op">*</span> <span class="kw">temp</span>,
    f_p_site         = <span class="fl">1</span> <span class="op">/</span> (<span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="op">-</span><span class="kw">f_p_site_lin</span>)),
    f_r_site         = <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw">alpha_f_r_site</span> <span class="op">+</span> <span class="kw">beta_f_r_site</span> <span class="op">*</span> <span class="kw">z_1</span> <span class="op">+</span> <span class="kw">beta_f_r_prec</span> <span class="op">*</span> <span class="kw">prec</span> <span class="op">+</span> <span class="kw">beta_f_r_temp</span> <span class="op">*</span> <span class="kw">temp</span>),
    data_list        = <span class="kw">all_pars</span>,
    states           = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"z"</span>)),
    has_hier_effs    = <span class="fl">TRUE</span>,
    levels_hier_effs = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(site = <span class="kw">LETTERS</span>[<span class="fl">1</span><span class="op">:</span><span class="fl">6</span>]),
    evict_cor        = <span class="fl">FALSE</span>
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span>(
    name          = <span class="st">"go_sb_2"</span>,
    family        = <span class="st">"DD"</span>,
    formula       = <span class="kw">s_sb1</span> <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> <span class="kw">r_sb1</span>),
    data_list     = <span class="kw">all_pars</span>,
    states        = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'z'</span>)),
    has_hier_effs = <span class="fl">FALSE</span>,
    evict_cor     = <span class="fl">FALSE</span>
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span>(
    name          = <span class="st">"leave_sb_1"</span>,
    family        = <span class="st">"DC"</span>,
    formula       = <span class="kw">s_sb1</span> <span class="op">*</span> <span class="kw">r_sb1</span> <span class="op">*</span> <span class="kw">f_d</span> <span class="op">*</span> <span class="kw">d_z</span>,
    f_d           = <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(<span class="kw">z_2</span>, <span class="kw">mu_f_d</span>, <span class="kw">sigma_f_d</span>),
    data_list     = <span class="kw">all_pars</span>,
    states        = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"z"</span>)),
    has_hier_effs = <span class="fl">FALSE</span>,
    evict_cor     = <span class="fl">TRUE</span>,
    evict_fun     = <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span>(<span class="st">"norm"</span>, <span class="st">"f_d"</span>)
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span>(
    name          = <span class="st">"leave_sb_2"</span>,
    family        = <span class="st">"DC"</span>,
    formula       = <span class="kw">s_sb2</span> <span class="op">*</span> <span class="kw">r_sb2</span> <span class="op">*</span> <span class="kw">f_d</span> <span class="op">*</span> <span class="kw">d_z</span>,
    f_d           = <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(<span class="kw">z_2</span>, <span class="kw">mu_f_d</span>, <span class="kw">sigma_f_d</span>),
    data_list     = <span class="kw">all_pars</span>,
    states        = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"z"</span>)),
    has_hier_effs = <span class="fl">FALSE</span>,
    evict_cor     = <span class="fl">TRUE</span>,
    evict_fun     = <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span>(<span class="st">"norm"</span>, <span class="st">"f_d"</span>)
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_k</a></span>(
    name             = <span class="st">"K_site"</span>,
    family           = <span class="st">"IPM"</span>,
    K_site           = <span class="kw">P_site</span> <span class="op">+</span> <span class="kw">F_site</span>,
    n_z_t_1          = <span class="kw">K_site</span>     <span class="op">%*%</span> <span class="kw">n_z_t</span>   <span class="op">+</span> 
                       <span class="kw">leave_sb_1</span> <span class="op">%*%</span> <span class="kw">n_sb1_t</span> <span class="op">+</span> 
                       <span class="kw">leave_sb_2</span> <span class="op">%*%</span> <span class="kw">n_sb2_t</span>,
    n_sb1_t_1        = <span class="kw">go_sb_1_site</span> <span class="op">%*%</span> <span class="kw">n_z_t</span>,
    n_sb2_t_1        = <span class="kw">go_sb_2</span> <span class="op">%*%</span> <span class="kw">n_sb1_t</span>,
    data_list        = <span class="kw">all_pars</span>,
    states           = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"z"</span>)),
    has_hier_effs    = <span class="fl">TRUE</span>,
    levels_hier_effs = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(site = <span class="kw">LETTERS</span>[<span class="fl">1</span><span class="op">:</span><span class="fl">6</span>]),
    evict_cor        = <span class="fl">FALSE</span>
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_impl</a></span>(
    <span class="fu"><a href="../reference/define_impl.html">make_impl_args_list</a></span>(
      kernel_names = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"P_site"</span>, <span class="st">"F_site"</span>,
                       <span class="st">"go_sb_1_site"</span>, <span class="st">"go_sb_2"</span>, 
                       <span class="st">"leave_sb_1"</span>, <span class="st">"leave_sb_2"</span>,
                       <span class="st">"K_site"</span>),
      int_rule     = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"midpoint"</span>, <span class="fl">7</span>),
      dom_start    = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"z"</span>, <span class="st">"z"</span>, <span class="st">"z"</span>, <span class="fl">NA_character_</span>, <span class="fl">NA_character_</span>, <span class="fl">NA_character_</span>, <span class="st">"z"</span>),
      dom_end      = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"z"</span>, <span class="st">"z"</span>, <span class="fl">NA_character_</span>, <span class="fl">NA_character_</span>, <span class="st">"z"</span>, <span class="st">"z"</span>, <span class="st">"Z"</span>)
    )
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_domains</a></span>(
    z = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.1</span>, <span class="fl">100</span>, <span class="fl">200</span>)
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_pop_state</a></span>(
    n_z   = <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">200</span>),
    n_sb1 = <span class="fl">20</span>,
    n_sb2 = <span class="fl">20</span>
  ) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_env_state</a></span>(
    env_state = <span class="fu">sample_fun</span>(<span class="kw">env_params</span>),
    data_list = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(env_params = <span class="kw">env_params</span>,
                     sample_fun = <span class="kw">sample_fun</span>)
  ) <span class="op">%&gt;%</span>  
  <span class="fu"><a href="../reference/make_ipm.html">make_ipm</a></span>(
    iterations         = <span class="fl">20</span>,
    kernel_seq         = <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="kw">LETTERS</span>[<span class="fl">1</span><span class="op">:</span><span class="fl">6</span>], <span class="fl">20</span>, replace = <span class="fl">TRUE</span>),
    normalize_pop_size = <span class="fl">TRUE</span>
  )
</pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/levisc8">Sam Levin</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
