<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>General IPMs • ipmr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="General IPMs">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ipmr</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/general-ipms.html">General IPMs</a>
    </li>
    <li>
      <a href="../articles/generic-funs.html">List of Generic and Helper Functions in ipmr</a>
    </li>
    <li>
      <a href="../articles/generic-progress.html">Generic Progress</a>
    </li>
    <li>
      <a href="../articles/hierarchical-notation.html">Hierarchical Notation</a>
    </li>
    <li>
      <a href="../articles/ipmr-introduction.html">Introduction to ipmr</a>
    </li>
    <li>
      <a href="../articles/proto-ipms.html">proto_ipm data structure</a>
    </li>
    <li>
      <a href="../articles/sanity-checks.html">Sanity checks for ipmr examples</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>General IPMs</h1>
                        <h4 class="author">Sam Levin</h4>
            
            <h4 class="date">2020-03-31</h4>
      
      
      <div class="hidden name"><code>general-ipms.Rmd</code></div>

    </div>

    
    
<div id="simple-ipms-vs-general-ipms" class="section level2">
<h2 class="hasAnchor">
<a href="#simple-ipms-vs-general-ipms" class="anchor"></a>Simple IPMs vs General IPMs</h2>
<p>General IPMs are distinguished from simple ones in that they incorporate multiple state variables and/or include transitions between continuous and discrete states. A more specific defintion is provided in Ellner, Childs &amp; Rees, Chapter 6 (2016).</p>
<p><code>ipmr</code> handles general IPMs fairly differently from <code>IPMpack</code> in that it requires the population state to be defined initially and will compute most quantities via iteration. For almost everything, <code>ipmr</code> skips building a mega-matrix (though <code><a href="../reference/eigenvectors.html">left_ev()</a></code> methods for general IPMs do require it). If the mega-matrix approach is preferable for some reason, the function <code>format_mega_matrix</code> is available to assist with constructing one. An example of how to do that is shown at the end of this vignette.</p>
</div>
<div id="a-general-density-independent-deterministic-ipm" class="section level2">
<h2 class="hasAnchor">
<a href="#a-general-density-independent-deterministic-ipm" class="anchor"></a>A general, density independent, deterministic IPM</h2>
<p>We’ll start with the least complicated of the general IPMs and build progressively from there. If you’ve already covered the <a href="https://levisc8.github.io/ipmr/articles/ipmr-introduction.html">Intro to ipmr</a>, then most of this will look pretty familiar. There are three new bits:</p>
<ol style="list-style-type: decimal">
<li><p>We are required to <code><a href="../reference/define_star.html">define_pop_state()</a></code> before calling <code><a href="../reference/make_ipm.html">make_ipm()</a></code>.</p></li>
<li><p>Each kernel that has an integration requires that <code>d_statevariable</code> get appended to the kernel <code>formula</code>. This is equivalent to the “dz” in <span class="math inline">\(\int_L^U K(z',z) n(z,t) \mathrm{dz}\)</span>. <code>ipmr</code> automatically generates this variable internally, so there is no need to define it in the <code>data_list</code>. We skipped this step in the simple IPMs because it gets appended internally. Unfortunately, it is decidedly less easy to infer the correct state variable to <code>d_z</code> with for general IPMs where there may be many continuous and/or discrete states.</p></li>
<li><p>We don’t necessarily define a formula for <span class="math inline">\(K(z',z)\)</span> as we did in the simple IPMs. This is due to the point above about using iteration based methods for computing. Instead, we define how the kernels manipulate different population states at time <span class="math inline">\(t\)</span> to produce new states at time <span class="math inline">\(t+1\)</span>.</p></li>
</ol>
<p>This example will use a single discrete stage (seed bank, abbreviated <code>b</code>) and a single continuous state (height, abbreviated <code>ht</code>). Reproduction is time-lagged so all seeds must enter the seed bank . They can either germinate in the next year, or they can die (so <code>stay_discrete</code> = 0). Thus, the full model takes the following form:</p>
<ol style="list-style-type: decimal">
<li><p><span class="math inline">\(n(z', t + 1) = \int_L^U P(z', z) n(z,t)d\mathrm{z} + b(t) * \int_L^U leave\_discrete(z') \mathrm{dz'}\)</span></p></li>
<li><p><span class="math inline">\(b(t + 1) = go\_discrete(z) + stay\_discrete\)</span></p></li>
<li><p><span class="math inline">\(P(z',z) = s * g\)</span></p></li>
<li><p><span class="math inline">\(go\_discrete(z) = f_s * f_r * g_i\)</span></p></li>
<li><p><span class="math inline">\(leave\_discrete(z') = e_p * f_d(z')\)</span></p></li>
<li><p><span class="math inline">\(stay\_discrete = 0\)</span></p></li>
</ol>
<p>The vital rates functions and example code to fit them are:</p>
<ol style="list-style-type: decimal">
<li>
<p>survival (<code>s</code>): A logistic regression</p>
<ul>
<li>Example code: <code><a href="https://rdrr.io/r/stats/glm.html">glm(surv ~ ht_1, data = my_surv_data, family = binomial())</a></code>
</li>
</ul>
</li>
<li>
<p>growth (<code>g</code>): A linear regression</p>
<ul>
<li>example code: <code><a href="https://rdrr.io/r/stats/lm.html">lm(ht_2 ~ ht_1, data = grow_data)</a></code>
</li>
</ul>
</li>
<li>
<p>flowering probability (<code>f_r</code>): A logistic regression</p>
<ul>
<li>example code: <code><a href="https://rdrr.io/r/stats/glm.html">glm(repro ~ ht_1, data = my_repro_data, family = binomial())</a></code>
</li>
</ul>
</li>
<li>
<p>seed production (<code>f_s</code>): A Poisson regression</p>
<ul>
<li>example code: <code><a href="https://rdrr.io/r/stats/glm.html">glm(seeds ~ ht_1, data = my_seed_data, family = poisson())</a></code>
</li>
</ul>
</li>
<li>
<p>Recruit size distribution (<code>f_d</code>): A normal distribution with mean <code>f_d_mu</code> and standard deviation <code>f_d_sd</code>.</p>
<ul>
<li>example code: <code>f_d_mu &lt;- mean(my_recr_data$ht_2, na.rm = TRUE)</code> and <code>f_d_sd &lt;- sd(my_rer_data$ht_2, na.rm = TRUE)</code>.</li>
</ul>
</li>
<li>
<p>germination (<code>g_i</code>) and establishment (<code>e_p</code>) are constants</p>
<ul>
<li>example code: <code>g_i &lt;- mean(my_germ_data, na.rm = TRUE)</code> and <code>e_p &lt;- mean(my_est_data, na.rm = TRUE)</code>
</li>
</ul>
</li>
</ol>
<p>Below is the code to implement this model. First, we define our our parameters in a list.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ipmr)</a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="co"># Set up the initial population conditions and parameters</span></a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5">data_list &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb1-6" title="6">  <span class="dt">g_int     =</span> <span class="fl">5.781</span>,</a>
<a class="sourceLine" id="cb1-7" title="7">  <span class="dt">g_slope   =</span> <span class="fl">0.988</span>,</a>
<a class="sourceLine" id="cb1-8" title="8">  <span class="dt">g_sd      =</span> <span class="fl">20.55699</span>,</a>
<a class="sourceLine" id="cb1-9" title="9">  <span class="dt">s_int     =</span> <span class="fl">-0.352</span>,</a>
<a class="sourceLine" id="cb1-10" title="10">  <span class="dt">s_slope   =</span> <span class="fl">0.122</span>,</a>
<a class="sourceLine" id="cb1-11" title="11">  <span class="dt">s_slope_2 =</span> <span class="fl">-0.000213</span>,</a>
<a class="sourceLine" id="cb1-12" title="12">  <span class="dt">f_r_int   =</span> <span class="fl">-11.46</span>,</a>
<a class="sourceLine" id="cb1-13" title="13">  <span class="dt">f_r_slope =</span> <span class="fl">0.0835</span>,</a>
<a class="sourceLine" id="cb1-14" title="14">  <span class="dt">f_s_int   =</span> <span class="fl">2.6204</span>,</a>
<a class="sourceLine" id="cb1-15" title="15">  <span class="dt">f_s_slope =</span> <span class="fl">0.01256</span>,</a>
<a class="sourceLine" id="cb1-16" title="16">  <span class="dt">f_d_mu    =</span> <span class="fl">5.6655</span>,</a>
<a class="sourceLine" id="cb1-17" title="17">  <span class="dt">f_d_sd    =</span> <span class="fl">2.0734</span>,</a>
<a class="sourceLine" id="cb1-18" title="18">  <span class="dt">e_p       =</span> <span class="fl">0.15</span>,</a>
<a class="sourceLine" id="cb1-19" title="19">  <span class="dt">g_i       =</span> <span class="fl">0.5067</span></a>
<a class="sourceLine" id="cb1-20" title="20">)</a></code></pre></div>
<p>Next, we set up the upper (<code>U</code>) and lower (<code>L</code>) bounds for integration, define the number of meshpoints for integration (<code>n</code>). We also define initial population vectors for both <code>b</code> and <code>ht</code>, set up our <code>states</code> list, and a couple functions to pass into the model.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="co"># The lower and upper bounds for the continuous state variable and the number</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co"># of meshpoints for the midpoint rule integration.</span></a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4">L &lt;-<span class="st"> </span><span class="fl">1.02</span></a>
<a class="sourceLine" id="cb2-5" title="5">U &lt;-<span class="st"> </span><span class="dv">624</span></a>
<a class="sourceLine" id="cb2-6" title="6">n &lt;-<span class="st"> </span><span class="dv">500</span></a>
<a class="sourceLine" id="cb2-7" title="7"></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">2312</span>)</a>
<a class="sourceLine" id="cb2-9" title="9"></a>
<a class="sourceLine" id="cb2-10" title="10">init_pop_vec   &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="dv">500</span>)</a>
<a class="sourceLine" id="cb2-11" title="11">init_seed_bank &lt;-<span class="st"> </span><span class="dv">20</span></a>
<a class="sourceLine" id="cb2-12" title="12"></a>
<a class="sourceLine" id="cb2-13" title="13"><span class="co"># Initialize the state list and add some helper functions. The survival function</span></a>
<a class="sourceLine" id="cb2-14" title="14"><span class="co"># in this model is a quadratic function.</span></a>
<a class="sourceLine" id="cb2-15" title="15"></a>
<a class="sourceLine" id="cb2-16" title="16">states &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'ht'</span>, <span class="st">'sb'</span>))</a>
<a class="sourceLine" id="cb2-17" title="17"></a>
<a class="sourceLine" id="cb2-18" title="18">inv_logit &lt;-<span class="st"> </span><span class="cf">function</span>(int, slope, sv) {</a>
<a class="sourceLine" id="cb2-19" title="19">  <span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="op">-</span>(int <span class="op">+</span><span class="st"> </span>slope <span class="op">*</span><span class="st"> </span>sv)))</a>
<a class="sourceLine" id="cb2-20" title="20">}</a>
<a class="sourceLine" id="cb2-21" title="21"></a>
<a class="sourceLine" id="cb2-22" title="22">inv_logit_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="cf">function</span>(int, slope, slope_<span class="dv">2</span>, sv) {</a>
<a class="sourceLine" id="cb2-23" title="23">  <span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="op">-</span>(int <span class="op">+</span><span class="st"> </span>slope <span class="op">*</span><span class="st"> </span>sv <span class="op">+</span><span class="st"> </span>slope_<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>sv <span class="op">^</span><span class="st"> </span><span class="dv">2</span>)))</a>
<a class="sourceLine" id="cb2-24" title="24">}</a></code></pre></div>
<p>Now, we’re ready to begin making the IPM kernels</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">general_ipm &lt;-<span class="st"> </span><span class="kw"><a href="../reference/init_ipm.html">init_ipm</a></span>(<span class="st">"general_di_det"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="st">  </span><span class="kw"><a href="../reference/kernel-definitions.html">define_kernel</a></span>(</a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="dt">name          =</span> <span class="st">"P"</span>,</a>
<a class="sourceLine" id="cb3-4" title="4">    </a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="co"># We add d_ht to formula to make sure integration is handled correctly.</span></a>
<a class="sourceLine" id="cb3-6" title="6">    <span class="co"># This variable is generated internally by make_ipm(), so we don't need</span></a>
<a class="sourceLine" id="cb3-7" title="7">    <span class="co"># to do anything else.</span></a>
<a class="sourceLine" id="cb3-8" title="8">    </a>
<a class="sourceLine" id="cb3-9" title="9">    <span class="dt">formula       =</span> <span class="kw"><a href="../reference/fun-mult-helpers.html">s_g_mult</a></span>(s, g) <span class="op">*</span><span class="st"> </span>d_ht,</a>
<a class="sourceLine" id="cb3-10" title="10">    </a>
<a class="sourceLine" id="cb3-11" title="11">    <span class="co"># The family argument tells ipmr what kind of transition this kernel describes.</span></a>
<a class="sourceLine" id="cb3-12" title="12">    <span class="co"># it can be "CC" for continuous -&gt; continuous, "DC" for discrete -&gt; continuous</span></a>
<a class="sourceLine" id="cb3-13" title="13">    <span class="co"># "CD" for continuous -&gt; discrete, or "DD" for discrete -&gt; discrete.</span></a>
<a class="sourceLine" id="cb3-14" title="14">    </a>
<a class="sourceLine" id="cb3-15" title="15">    <span class="dt">family        =</span> <span class="st">"CC"</span>,</a>
<a class="sourceLine" id="cb3-16" title="16">    </a>
<a class="sourceLine" id="cb3-17" title="17">    <span class="co"># The rest of the arguments are exactly the same as in the simple models</span></a>
<a class="sourceLine" id="cb3-18" title="18">    </a>
<a class="sourceLine" id="cb3-19" title="19">    <span class="dt">g             =</span> <span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(ht_<span class="dv">2</span>, g_mu, g_sd),</a>
<a class="sourceLine" id="cb3-20" title="20">    <span class="dt">g_mu          =</span> g_int <span class="op">+</span><span class="st"> </span>g_slope <span class="op">*</span><span class="st"> </span>ht_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb3-21" title="21">    <span class="dt">s             =</span> <span class="kw">inv_logit_2</span>(s_int, s_slope, s_slope_<span class="dv">2</span>, ht_<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb3-22" title="22">    <span class="dt">data_list     =</span> data_list,</a>
<a class="sourceLine" id="cb3-23" title="23">    <span class="dt">states        =</span> states,</a>
<a class="sourceLine" id="cb3-24" title="24">    <span class="dt">has_hier_effs =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb3-25" title="25">    <span class="dt">evict_cor     =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb3-26" title="26">    <span class="dt">evict_fun     =</span> <span class="kw"><a href="../reference/eviction.html">truncated_distributions</a></span>(<span class="st">'norm'</span>,</a>
<a class="sourceLine" id="cb3-27" title="27">                                            <span class="st">'g'</span>)</a>
<a class="sourceLine" id="cb3-28" title="28">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-29" title="29"><span class="st">  </span><span class="kw"><a href="../reference/kernel-definitions.html">define_kernel</a></span>(</a>
<a class="sourceLine" id="cb3-30" title="30">    <span class="dt">name          =</span> <span class="st">"go_discrete"</span>,</a>
<a class="sourceLine" id="cb3-31" title="31">    <span class="dt">formula       =</span> f_r <span class="op">*</span><span class="st"> </span>f_s <span class="op">*</span><span class="st"> </span>g_i,</a>
<a class="sourceLine" id="cb3-32" title="32">    </a>
<a class="sourceLine" id="cb3-33" title="33">    <span class="co"># Note that now, family = "CD" becuase it denotes a continuous -&gt; discrete transition</span></a>
<a class="sourceLine" id="cb3-34" title="34">    </a>
<a class="sourceLine" id="cb3-35" title="35">    <span class="dt">family        =</span> <span class="st">'CD'</span>,</a>
<a class="sourceLine" id="cb3-36" title="36">    <span class="dt">f_r           =</span> <span class="kw">inv_logit</span>(f_r_int, f_r_slope, ht_<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb3-37" title="37">    <span class="dt">f_s           =</span> <span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(f_s_int <span class="op">+</span><span class="st"> </span>f_s_slope <span class="op">*</span><span class="st"> </span>ht_<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb3-38" title="38">    <span class="dt">data_list     =</span> data_list,</a>
<a class="sourceLine" id="cb3-39" title="39">    <span class="dt">states        =</span> states,</a>
<a class="sourceLine" id="cb3-40" title="40">    <span class="dt">has_hier_effs =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb3-41" title="41">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-42" title="42"><span class="st">  </span><span class="kw"><a href="../reference/kernel-definitions.html">define_kernel</a></span>(</a>
<a class="sourceLine" id="cb3-43" title="43">    <span class="dt">name    =</span> <span class="st">'stay_discrete'</span>,</a>
<a class="sourceLine" id="cb3-44" title="44">    </a>
<a class="sourceLine" id="cb3-45" title="45">    <span class="co"># In this case, seeds in the seed bank either germinate or die, but they </span></a>
<a class="sourceLine" id="cb3-46" title="46">    <span class="co"># do not remain for multipe time steps. This can be adjusted as needed.</span></a>
<a class="sourceLine" id="cb3-47" title="47">    </a>
<a class="sourceLine" id="cb3-48" title="48">    <span class="dt">formula =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-49" title="49">    </a>
<a class="sourceLine" id="cb3-50" title="50">    <span class="co"># Note that now, family = "DD" becuase it denotes a discrete -&gt; discrete transition</span></a>
<a class="sourceLine" id="cb3-51" title="51">    </a>
<a class="sourceLine" id="cb3-52" title="52">    <span class="dt">family  =</span> <span class="st">"DD"</span>,</a>
<a class="sourceLine" id="cb3-53" title="53">    <span class="dt">states  =</span> states,</a>
<a class="sourceLine" id="cb3-54" title="54">    <span class="dt">evict_cor =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb3-55" title="55">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-56" title="56"><span class="st">  </span><span class="kw"><a href="../reference/kernel-definitions.html">define_kernel</a></span>(</a>
<a class="sourceLine" id="cb3-57" title="57">    </a>
<a class="sourceLine" id="cb3-58" title="58">    <span class="co"># Here, the family changes to "DC" because it is the discrete -&gt; continuous </span></a>
<a class="sourceLine" id="cb3-59" title="59">    <span class="co"># transition</span></a>
<a class="sourceLine" id="cb3-60" title="60">    </a>
<a class="sourceLine" id="cb3-61" title="61">    <span class="dt">name          =</span> <span class="st">'leave_discrete'</span>,</a>
<a class="sourceLine" id="cb3-62" title="62">    </a>
<a class="sourceLine" id="cb3-63" title="63">    <span class="co"># We append d_ht here as well, becuase we need to integrate over the </span></a>
<a class="sourceLine" id="cb3-64" title="64">    <span class="co"># the recruit size distribution.</span></a>
<a class="sourceLine" id="cb3-65" title="65">    </a>
<a class="sourceLine" id="cb3-66" title="66">    <span class="dt">formula       =</span> e_p <span class="op">*</span><span class="st"> </span>f_d <span class="op">*</span><span class="st"> </span>d_ht,</a>
<a class="sourceLine" id="cb3-67" title="67">    <span class="dt">f_d           =</span> <span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(ht_<span class="dv">2</span>, f_d_mu, f_d_sd),</a>
<a class="sourceLine" id="cb3-68" title="68">    <span class="dt">family        =</span> <span class="st">'DC'</span>,</a>
<a class="sourceLine" id="cb3-69" title="69">    <span class="dt">data_list     =</span> data_list,</a>
<a class="sourceLine" id="cb3-70" title="70">    <span class="dt">states        =</span> states,</a>
<a class="sourceLine" id="cb3-71" title="71">    <span class="dt">has_hier_effs =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb3-72" title="72">    <span class="dt">evict_cor     =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb3-73" title="73">    <span class="dt">evict_fun     =</span> <span class="kw"><a href="../reference/eviction.html">truncated_distributions</a></span>(<span class="st">'norm'</span>,</a>
<a class="sourceLine" id="cb3-74" title="74">                                            <span class="st">'f_d'</span>)</a>
<a class="sourceLine" id="cb3-75" title="75">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-76" title="76"><span class="st">  </span><span class="kw"><a href="../reference/kernel-definitions.html">define_k</a></span>(</a>
<a class="sourceLine" id="cb3-77" title="77">    <span class="dt">name          =</span> <span class="st">"K"</span>,</a>
<a class="sourceLine" id="cb3-78" title="78">    <span class="dt">family        =</span> <span class="st">"IPM"</span>,</a>
<a class="sourceLine" id="cb3-79" title="79">    </a>
<a class="sourceLine" id="cb3-80" title="80">    <span class="co"># We don't really define a mega-K as we do with simple models, but rather</span></a>
<a class="sourceLine" id="cb3-81" title="81">    <span class="co"># describe how the state at t is modified by the sub-kernels to produce</span></a>
<a class="sourceLine" id="cb3-82" title="82">    <span class="co"># the state at t + 1. </span></a>
<a class="sourceLine" id="cb3-83" title="83">    </a>
<a class="sourceLine" id="cb3-84" title="84">    <span class="dt">n_b_t_1       =</span> stay_discrete <span class="op">%*%</span><span class="st"> </span>n_b_t  <span class="op">+</span><span class="st"> </span>go_discrete <span class="op">%*%</span><span class="st"> </span>n_ht_t,</a>
<a class="sourceLine" id="cb3-85" title="85">    <span class="dt">n_ht_t_1      =</span> leave_discrete <span class="op">%*%</span><span class="st"> </span>n_b_t <span class="op">+</span><span class="st"> </span>P <span class="op">%*%</span><span class="st"> </span>n_ht_t,</a>
<a class="sourceLine" id="cb3-86" title="86">    <span class="dt">data_list     =</span> data_list,</a>
<a class="sourceLine" id="cb3-87" title="87">    <span class="dt">states        =</span> states,</a>
<a class="sourceLine" id="cb3-88" title="88">    <span class="dt">has_hier_effs =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb3-89" title="89">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-90" title="90"><span class="st">  </span><span class="kw"><a href="../reference/define_star.html">define_impl</a></span>(</a>
<a class="sourceLine" id="cb3-91" title="91">    <span class="kw"><a href="../reference/define_star.html">make_impl_args_list</a></span>(</a>
<a class="sourceLine" id="cb3-92" title="92">      <span class="dt">kernel_names =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"P"</span>, <span class="st">"go_discrete"</span>, <span class="st">"stay_discrete"</span>, <span class="st">"leave_discrete"</span>, <span class="st">"K"</span>),</a>
<a class="sourceLine" id="cb3-93" title="93">      <span class="dt">int_rule     =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"midpoint"</span>, <span class="dv">5</span>)),</a>
<a class="sourceLine" id="cb3-94" title="94">      <span class="dt">dom_start    =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'ht'</span>, <span class="st">"ht"</span>, <span class="ot">NA_character_</span>, <span class="ot">NA_character_</span>, <span class="st">"ht"</span>),</a>
<a class="sourceLine" id="cb3-95" title="95">      <span class="dt">dom_end      =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'ht'</span>, <span class="ot">NA_character_</span>, <span class="ot">NA_character_</span>, <span class="st">'ht'</span>, <span class="st">'ht'</span>)</a>
<a class="sourceLine" id="cb3-96" title="96">    )</a>
<a class="sourceLine" id="cb3-97" title="97">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-98" title="98"><span class="st">  </span><span class="kw"><a href="../reference/define_star.html">define_domains</a></span>(</a>
<a class="sourceLine" id="cb3-99" title="99">    </a>
<a class="sourceLine" id="cb3-100" title="100">    <span class="co"># We can pass the variables we created above into define_domains</span></a>
<a class="sourceLine" id="cb3-101" title="101">    </a>
<a class="sourceLine" id="cb3-102" title="102">    <span class="dt">ht =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(L, U, n)</a>
<a class="sourceLine" id="cb3-103" title="103">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-104" title="104"><span class="st">  </span><span class="kw"><a href="../reference/define_star.html">define_pop_state</a></span>(</a>
<a class="sourceLine" id="cb3-105" title="105">    </a>
<a class="sourceLine" id="cb3-106" title="106">    <span class="co"># We can also pass them into define_pop_state</span></a>
<a class="sourceLine" id="cb3-107" title="107">    </a>
<a class="sourceLine" id="cb3-108" title="108">    <span class="dt">pop_vectors =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb3-109" title="109">      <span class="dt">n_ht =</span> init_pop_vec,</a>
<a class="sourceLine" id="cb3-110" title="110">      <span class="dt">n_b  =</span> init_seed_bank</a>
<a class="sourceLine" id="cb3-111" title="111">    )</a>
<a class="sourceLine" id="cb3-112" title="112">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-113" title="113"><span class="st">  </span><span class="co"># make_ipm() has iterate = TRUE by default for general IPMs.</span></a>
<a class="sourceLine" id="cb3-114" title="114"><span class="st">  </span><span class="kw"><a href="../reference/make_ipm.html">make_ipm</a></span>(<span class="dt">iterations =</span> <span class="dv">100</span>,</a>
<a class="sourceLine" id="cb3-115" title="115">           <span class="dt">usr_funs =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">inv_logit   =</span> inv_logit,</a>
<a class="sourceLine" id="cb3-116" title="116">                           <span class="dt">inv_logit_2 =</span> inv_logit_<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb3-117" title="117"></a>
<a class="sourceLine" id="cb3-118" title="118"></a>
<a class="sourceLine" id="cb3-119" title="119"><span class="co"># lambda is a generic function to compute per-capita growth rates. It has a number</span></a>
<a class="sourceLine" id="cb3-120" title="120"><span class="co"># of different options which are explored in the "Generics" vignette (still to be</span></a>
<a class="sourceLine" id="cb3-121" title="121"><span class="co"># written!).</span></a>
<a class="sourceLine" id="cb3-122" title="122"></a>
<a class="sourceLine" id="cb3-123" title="123"><span class="kw"><a href="../reference/lambda.html">lambda</a></span>(general_ipm, <span class="dt">comp_method =</span> <span class="st">'pop_size'</span>)[<span class="dv">100</span>]</a>
<a class="sourceLine" id="cb3-124" title="124"></a>
<a class="sourceLine" id="cb3-125" title="125"><span class="co"># If we are worried about whether or not the model converged to stable</span></a>
<a class="sourceLine" id="cb3-126" title="126"><span class="co"># dynamics, we can use the exported utility is_conv_to_asymptotic. The default</span></a>
<a class="sourceLine" id="cb3-127" title="127"><span class="co"># tolerance for convergence is 1e-10, but can be changed with the 'tol' argument.</span></a>
<a class="sourceLine" id="cb3-128" title="128"></a>
<a class="sourceLine" id="cb3-129" title="129"><span class="kw"><a href="../reference/check_convergence.html">is_conv_to_asymptotic</a></span>(general_ipm, <span class="dt">tol =</span> <span class="fl">1e-10</span>)</a></code></pre></div>
</div>
<div id="general-models-for-discretely-varying-environments" class="section level2">
<h2 class="hasAnchor">
<a href="#general-models-for-discretely-varying-environments" class="anchor"></a>General models for discretely varying environments</h2>
<p>Discretely varying parameters can be used to construct general IPMs with little additional effort. These are typically the result of fitting a set of fixed effects vital rate models that include both continuous predictors for size/state and categorical variables like treatment or maturation state. They can also result from mixed effects models, for example, working with conditional modes for a random intercept corresponding to year or site.</p>
<p>If you’ve already read the Intro to <code>ipmr</code> article and the example above, then there aren’t any new concepts to introduce here. We just need to combine the hierarchical notation with the key points listed above (add <code>d_z</code>, <code><a href="../reference/define_star.html">define_pop_state()</a></code>, and forget about mega-matrices). Below is an example showing how all of these come together.</p>
</div>
<div id="general-models-with-continuously-varying-environments" class="section level2">
<h2 class="hasAnchor">
<a href="#general-models-with-continuously-varying-environments" class="anchor"></a>General models with continuously varying environments</h2>
</div>
<div id="code-to-construct-your-own-mega-matrices" class="section level2">
<h2 class="hasAnchor">
<a href="#code-to-construct-your-own-mega-matrices" class="anchor"></a>Code to construct your own mega-matrices</h2>
<p>Iteration is all fine and good, and can be used to get most quantities. Issues arise when we need to, say, transpose a model (e.g. to compute the left eigenvector of the full discretized model). <code>ipmr</code> doesn’t define a strict order in which to define expressions in <code><a href="../reference/kernel-definitions.html">define_k()</a></code>, providing flexibility to define these however you see fit. The cost is that, internally, <code>ipmr</code> has no idea where things should go when transposing the model. This is where <code><a href="../reference/format_mega_matrix.html">format_mega_matrix()</a></code> comes in.</p>
<p><code>format_mega_matrix</code> takes an IPM object and a vector of symbols (for interactive use) or a character version of the expression (for programming) showing where each sub-kernel should go. It works in <strong>ROW MAJOR order</strong>. This example will use the model from the general deterministic example at the top of the article.</p>
<p>First, re-run the model to create the IPM object (if you haven’t already).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">data_list &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="dt">g_int     =</span> <span class="fl">5.781</span>,</a>
<a class="sourceLine" id="cb4-3" title="3">  <span class="dt">g_slope   =</span> <span class="fl">0.988</span>,</a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="dt">g_sd      =</span> <span class="fl">20.55699</span>,</a>
<a class="sourceLine" id="cb4-5" title="5">  <span class="dt">s_int     =</span> <span class="fl">-0.352</span>,</a>
<a class="sourceLine" id="cb4-6" title="6">  <span class="dt">s_slope   =</span> <span class="fl">0.122</span>,</a>
<a class="sourceLine" id="cb4-7" title="7">  <span class="dt">s_slope_2 =</span> <span class="fl">-0.000213</span>,</a>
<a class="sourceLine" id="cb4-8" title="8">  <span class="dt">f_r_int   =</span> <span class="fl">-11.46</span>,</a>
<a class="sourceLine" id="cb4-9" title="9">  <span class="dt">f_r_slope =</span> <span class="fl">0.0835</span>,</a>
<a class="sourceLine" id="cb4-10" title="10">  <span class="dt">f_s_int   =</span> <span class="fl">2.6204</span>,</a>
<a class="sourceLine" id="cb4-11" title="11">  <span class="dt">f_s_slope =</span> <span class="fl">0.01256</span>,</a>
<a class="sourceLine" id="cb4-12" title="12">  <span class="dt">f_d_mu    =</span> <span class="fl">5.6655</span>,</a>
<a class="sourceLine" id="cb4-13" title="13">  <span class="dt">f_d_sd    =</span> <span class="fl">2.0734</span>,</a>
<a class="sourceLine" id="cb4-14" title="14">  <span class="dt">e_p       =</span> <span class="fl">0.15</span>,</a>
<a class="sourceLine" id="cb4-15" title="15">  <span class="dt">g_i       =</span> <span class="fl">0.5067</span></a>
<a class="sourceLine" id="cb4-16" title="16">)</a>
<a class="sourceLine" id="cb4-17" title="17"></a>
<a class="sourceLine" id="cb4-18" title="18"></a>
<a class="sourceLine" id="cb4-19" title="19">L &lt;-<span class="st"> </span><span class="fl">1.02</span></a>
<a class="sourceLine" id="cb4-20" title="20">U &lt;-<span class="st"> </span><span class="dv">624</span></a>
<a class="sourceLine" id="cb4-21" title="21">n &lt;-<span class="st"> </span><span class="dv">500</span></a>
<a class="sourceLine" id="cb4-22" title="22"></a>
<a class="sourceLine" id="cb4-23" title="23"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">2312</span>)</a>
<a class="sourceLine" id="cb4-24" title="24"></a>
<a class="sourceLine" id="cb4-25" title="25">init_pop_vec   &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="dv">500</span>)</a>
<a class="sourceLine" id="cb4-26" title="26">init_seed_bank &lt;-<span class="st"> </span><span class="dv">20</span></a>
<a class="sourceLine" id="cb4-27" title="27"></a>
<a class="sourceLine" id="cb4-28" title="28"><span class="co"># Initialize the state list and add some helper functions. The survival function</span></a>
<a class="sourceLine" id="cb4-29" title="29"><span class="co"># in this model is a quadratic function.</span></a>
<a class="sourceLine" id="cb4-30" title="30"></a>
<a class="sourceLine" id="cb4-31" title="31">states &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'ht'</span>, <span class="st">'sb'</span>))</a>
<a class="sourceLine" id="cb4-32" title="32"></a>
<a class="sourceLine" id="cb4-33" title="33">inv_logit &lt;-<span class="st"> </span><span class="cf">function</span>(int, slope, sv) {</a>
<a class="sourceLine" id="cb4-34" title="34">  <span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="op">-</span>(int <span class="op">+</span><span class="st"> </span>slope <span class="op">*</span><span class="st"> </span>sv)))</a>
<a class="sourceLine" id="cb4-35" title="35">}</a>
<a class="sourceLine" id="cb4-36" title="36"></a>
<a class="sourceLine" id="cb4-37" title="37">inv_logit_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="cf">function</span>(int, slope, slope_<span class="dv">2</span>, sv) {</a>
<a class="sourceLine" id="cb4-38" title="38">  <span class="dv">1</span><span class="op">/</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="op">-</span>(int <span class="op">+</span><span class="st"> </span>slope <span class="op">*</span><span class="st"> </span>sv <span class="op">+</span><span class="st"> </span>slope_<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>sv <span class="op">^</span><span class="st"> </span><span class="dv">2</span>)))</a>
<a class="sourceLine" id="cb4-39" title="39">}</a>
<a class="sourceLine" id="cb4-40" title="40"></a>
<a class="sourceLine" id="cb4-41" title="41">general_ipm &lt;-<span class="st"> </span><span class="kw"><a href="../reference/init_ipm.html">init_ipm</a></span>(<span class="st">"general_di_det"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-42" title="42"><span class="st">  </span><span class="kw"><a href="../reference/kernel-definitions.html">define_kernel</a></span>(</a>
<a class="sourceLine" id="cb4-43" title="43">    <span class="dt">name          =</span> <span class="st">"P"</span>,</a>
<a class="sourceLine" id="cb4-44" title="44">    <span class="dt">formula       =</span> <span class="kw"><a href="../reference/fun-mult-helpers.html">s_g_mult</a></span>(s, g) <span class="op">*</span><span class="st"> </span>d_ht,</a>
<a class="sourceLine" id="cb4-45" title="45">    <span class="dt">family        =</span> <span class="st">"CC"</span>,</a>
<a class="sourceLine" id="cb4-46" title="46">    <span class="dt">g             =</span> <span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(ht_<span class="dv">2</span>, g_mu, g_sd),</a>
<a class="sourceLine" id="cb4-47" title="47">    <span class="dt">g_mu          =</span> g_int <span class="op">+</span><span class="st"> </span>g_slope <span class="op">*</span><span class="st"> </span>ht_<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb4-48" title="48">    <span class="dt">s             =</span> <span class="kw">inv_logit_2</span>(s_int, s_slope, s_slope_<span class="dv">2</span>, ht_<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb4-49" title="49">    <span class="dt">data_list     =</span> data_list,</a>
<a class="sourceLine" id="cb4-50" title="50">    <span class="dt">states        =</span> states,</a>
<a class="sourceLine" id="cb4-51" title="51">    <span class="dt">has_hier_effs =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb4-52" title="52">    <span class="dt">evict_cor     =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb4-53" title="53">    <span class="dt">evict_fun     =</span> <span class="kw"><a href="../reference/eviction.html">truncated_distributions</a></span>(<span class="st">'norm'</span>,</a>
<a class="sourceLine" id="cb4-54" title="54">                                            <span class="st">'g'</span>)</a>
<a class="sourceLine" id="cb4-55" title="55">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-56" title="56"><span class="st">  </span><span class="kw"><a href="../reference/kernel-definitions.html">define_kernel</a></span>(</a>
<a class="sourceLine" id="cb4-57" title="57">    <span class="dt">name          =</span> <span class="st">"go_discrete"</span>,</a>
<a class="sourceLine" id="cb4-58" title="58">    <span class="dt">formula       =</span> f_r <span class="op">*</span><span class="st"> </span>f_s <span class="op">*</span><span class="st"> </span>g_i,</a>
<a class="sourceLine" id="cb4-59" title="59">    <span class="dt">family        =</span> <span class="st">'CD'</span>,</a>
<a class="sourceLine" id="cb4-60" title="60">    <span class="dt">f_r           =</span> <span class="kw">inv_logit</span>(f_r_int, f_r_slope, ht_<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb4-61" title="61">    <span class="dt">f_s           =</span> <span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(f_s_int <span class="op">+</span><span class="st"> </span>f_s_slope <span class="op">*</span><span class="st"> </span>ht_<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb4-62" title="62">    <span class="dt">data_list     =</span> data_list,</a>
<a class="sourceLine" id="cb4-63" title="63">    <span class="dt">states        =</span> states,</a>
<a class="sourceLine" id="cb4-64" title="64">    <span class="dt">has_hier_effs =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb4-65" title="65">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-66" title="66"><span class="st">  </span><span class="kw"><a href="../reference/kernel-definitions.html">define_kernel</a></span>(</a>
<a class="sourceLine" id="cb4-67" title="67">    <span class="dt">name      =</span> <span class="st">'stay_discrete'</span>,</a>
<a class="sourceLine" id="cb4-68" title="68">    <span class="dt">formula   =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb4-69" title="69">    <span class="dt">family    =</span> <span class="st">"DD"</span>,  </a>
<a class="sourceLine" id="cb4-70" title="70">    <span class="dt">states    =</span> states,</a>
<a class="sourceLine" id="cb4-71" title="71">    <span class="dt">evict_cor =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb4-72" title="72">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-73" title="73"><span class="st">  </span><span class="kw"><a href="../reference/kernel-definitions.html">define_kernel</a></span>(</a>
<a class="sourceLine" id="cb4-74" title="74">    <span class="dt">name          =</span> <span class="st">'leave_discrete'</span>,</a>
<a class="sourceLine" id="cb4-75" title="75">    <span class="dt">formula       =</span> e_p <span class="op">*</span><span class="st"> </span>f_d <span class="op">*</span><span class="st"> </span>d_ht,</a>
<a class="sourceLine" id="cb4-76" title="76">    <span class="dt">f_d           =</span> <span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(ht_<span class="dv">2</span>, f_d_mu, f_d_sd),</a>
<a class="sourceLine" id="cb4-77" title="77">    <span class="dt">family        =</span> <span class="st">'DC'</span>,</a>
<a class="sourceLine" id="cb4-78" title="78">    <span class="dt">data_list     =</span> data_list,</a>
<a class="sourceLine" id="cb4-79" title="79">    <span class="dt">states        =</span> states,</a>
<a class="sourceLine" id="cb4-80" title="80">    <span class="dt">has_hier_effs =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb4-81" title="81">    <span class="dt">evict_cor     =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb4-82" title="82">    <span class="dt">evict_fun     =</span> <span class="kw"><a href="../reference/eviction.html">truncated_distributions</a></span>(<span class="st">'norm'</span>,</a>
<a class="sourceLine" id="cb4-83" title="83">                                            <span class="st">'f_d'</span>)</a>
<a class="sourceLine" id="cb4-84" title="84">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-85" title="85"><span class="st">  </span><span class="kw"><a href="../reference/kernel-definitions.html">define_k</a></span>(</a>
<a class="sourceLine" id="cb4-86" title="86">    <span class="dt">name          =</span> <span class="st">"K"</span>,</a>
<a class="sourceLine" id="cb4-87" title="87">    <span class="dt">family        =</span> <span class="st">"IPM"</span>,</a>
<a class="sourceLine" id="cb4-88" title="88">    <span class="dt">n_b_t_1       =</span> stay_discrete <span class="op">%*%</span><span class="st"> </span>n_b_t  <span class="op">+</span><span class="st"> </span>go_discrete <span class="op">%*%</span><span class="st"> </span>n_ht_t,</a>
<a class="sourceLine" id="cb4-89" title="89">    <span class="dt">n_ht_t_1      =</span> leave_discrete <span class="op">%*%</span><span class="st"> </span>n_b_t <span class="op">+</span><span class="st"> </span>P <span class="op">%*%</span><span class="st"> </span>n_ht_t,</a>
<a class="sourceLine" id="cb4-90" title="90">    <span class="dt">data_list     =</span> data_list,</a>
<a class="sourceLine" id="cb4-91" title="91">    <span class="dt">states        =</span> states,</a>
<a class="sourceLine" id="cb4-92" title="92">    <span class="dt">has_hier_effs =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb4-93" title="93">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-94" title="94"><span class="st">  </span><span class="kw"><a href="../reference/define_star.html">define_impl</a></span>(</a>
<a class="sourceLine" id="cb4-95" title="95">    <span class="kw"><a href="../reference/define_star.html">make_impl_args_list</a></span>(</a>
<a class="sourceLine" id="cb4-96" title="96">      <span class="dt">kernel_names =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"P"</span>, <span class="st">"go_discrete"</span>, <span class="st">"stay_discrete"</span>, <span class="st">"leave_discrete"</span>, <span class="st">"K"</span>),</a>
<a class="sourceLine" id="cb4-97" title="97">      <span class="dt">int_rule     =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"midpoint"</span>, <span class="dv">5</span>)),</a>
<a class="sourceLine" id="cb4-98" title="98">      <span class="dt">dom_start    =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'ht'</span>, <span class="st">"ht"</span>, <span class="ot">NA_character_</span>, <span class="ot">NA_character_</span>, <span class="st">"ht"</span>),</a>
<a class="sourceLine" id="cb4-99" title="99">      <span class="dt">dom_end      =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'ht'</span>, <span class="ot">NA_character_</span>, <span class="ot">NA_character_</span>, <span class="st">'ht'</span>, <span class="st">'ht'</span>)</a>
<a class="sourceLine" id="cb4-100" title="100">    )</a>
<a class="sourceLine" id="cb4-101" title="101">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-102" title="102"><span class="st">  </span><span class="kw"><a href="../reference/define_star.html">define_domains</a></span>(</a>
<a class="sourceLine" id="cb4-103" title="103">    <span class="dt">ht =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(L, U, n)</a>
<a class="sourceLine" id="cb4-104" title="104">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-105" title="105"><span class="st">  </span><span class="kw"><a href="../reference/define_star.html">define_pop_state</a></span>(</a>
<a class="sourceLine" id="cb4-106" title="106">    <span class="dt">pop_vectors =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</a>
<a class="sourceLine" id="cb4-107" title="107">      <span class="dt">n_ht =</span> init_pop_vec,</a>
<a class="sourceLine" id="cb4-108" title="108">      <span class="dt">n_b  =</span> init_seed_bank</a>
<a class="sourceLine" id="cb4-109" title="109">    )</a>
<a class="sourceLine" id="cb4-110" title="110">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-111" title="111"><span class="st">  </span><span class="kw"><a href="../reference/make_ipm.html">make_ipm</a></span>(<span class="dt">iterations =</span> <span class="dv">100</span>,</a>
<a class="sourceLine" id="cb4-112" title="112">           <span class="dt">usr_funs =</span> <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">inv_logit   =</span> inv_logit,</a>
<a class="sourceLine" id="cb4-113" title="113">                           <span class="dt">inv_logit_2 =</span> inv_logit_<span class="dv">2</span>))</a></code></pre></div>
<p>Now, we specify which kernel belongs where in row major order, using a call to <code><a href="https://rdrr.io/r/base/c.html">c()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">mega_mat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/format_mega_matrix.html">format_mega_matrix</a></span>(<span class="dt">ipm =</span> general_ipm,</a>
<a class="sourceLine" id="cb5-2" title="2">                               <span class="dt">mega_mat =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb5-3" title="3">                                 stay_discrete, go_discrete,</a>
<a class="sourceLine" id="cb5-4" title="4">                                 leave_discrete, P</a>
<a class="sourceLine" id="cb5-5" title="5">                               ))</a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="co"># These values should be almost identical, so this should ~0</span></a>
<a class="sourceLine" id="cb5-8" title="8"></a>
<a class="sourceLine" id="cb5-9" title="9"><span class="kw"><a href="https://rdrr.io/r/base/complex.html">Re</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/eigen.html">eigen</a></span>(mega_mat)<span class="op">$</span>values[<span class="dv">1</span>]) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="../reference/lambda.html">lambda</a></span>(general_ipm)[<span class="dv">100</span>]</a></code></pre></div>
<p>Say you wanted to program with this function. Passing bare expression is difficult programatically, and how to do that is not really within the scope of this vignette (though if you’re interested in learning how, <a href="https://dplyr.tidyverse.org/articles/programming.html">this</a> is a good start). <code>format_mega_matrix</code> also accepts text strings in the same format as above.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="co"># Get the names of each sub_kernel</span></a>
<a class="sourceLine" id="cb6-2" title="2">sub_k_nms     &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(general_ipm<span class="op">$</span>sub_kernels)</a>
<a class="sourceLine" id="cb6-3" title="3"></a>
<a class="sourceLine" id="cb6-4" title="4">mega_mat_text &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">'c('</span>, sub_k_nms[<span class="dv">3</span>], <span class="st">', '</span>, sub_k_nms[<span class="dv">2</span>], <span class="st">', '</span>,</a>
<a class="sourceLine" id="cb6-5" title="5">                       sub_k_nms[<span class="dv">4</span>], <span class="st">', '</span>, sub_k_nms[<span class="dv">1</span>], <span class="st">')'</span> , <span class="dt">sep =</span> <span class="st">""</span>)</a>
<a class="sourceLine" id="cb6-6" title="6"></a>
<a class="sourceLine" id="cb6-7" title="7">mega_mat_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/format_mega_matrix.html">format_mega_matrix</a></span>(general_ipm,</a>
<a class="sourceLine" id="cb6-8" title="8">                                 mega_mat_text)</a>
<a class="sourceLine" id="cb6-9" title="9"></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="co"># Should be TRUE</span></a>
<a class="sourceLine" id="cb6-11" title="11"><span class="kw"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(mega_mat, mega_mat_<span class="dv">2</span>)</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#simple-ipms-vs-general-ipms">Simple IPMs vs General IPMs</a></li>
      <li><a href="#a-general-density-independent-deterministic-ipm">A general, density independent, deterministic IPM</a></li>
      <li><a href="#general-models-for-discretely-varying-environments">General models for discretely varying environments</a></li>
      <li><a href="#general-models-with-continuously-varying-environments">General models with continuously varying environments</a></li>
      <li><a href="#code-to-construct-your-own-mega-matrices">Code to construct your own mega-matrices</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/levisc8">Sam Levin</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
