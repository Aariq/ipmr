<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>General IPMs • ipmr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="General IPMs">
<meta property="og:description" content="ipmr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ipmr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    <li class="dropdown-header">Introduction to ipmr</li>
    <li>
      <a href="../articles/ipmr-introduction.html">Introduction to ipmr</a>
    </li>
    <li>
      <a href="../articles/general-ipms.html">General IPMs</a>
    </li>
    <li>
      <a href="../articles/suffix-notation.html">Suffix Notation</a>
    </li>
    <li>
      <a href="../articles/age_x_size.html">Age-Size IPMs</a>
    </li>
    <li>
      <a href="../articles/density-dependence.html">Density Dependent IPMs</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Generic Functions</li>
    <li>
      <a href="../articles/generic-funs.html">List of Generic and Helper Functions in ipmr</a>
    </li>
    <li>
      <a href="../articles/generic-progress.html">Generic Progress</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">proto_ipm Overview</li>
    <li>
      <a href="../articles/proto-ipms.html">proto_ipm Data Structure</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/levisc8/ipmr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="general-ipms_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>General IPMs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/levisc8/ipmr/blob/master/vignettes/general-ipms.Rmd"><code>vignettes/general-ipms.Rmd</code></a></small>
      <div class="hidden name"><code>general-ipms.Rmd</code></div>

    </div>

    
    
<div id="simple-ipms-vs-general-ipms" class="section level2">
<h2 class="hasAnchor">
<a href="#simple-ipms-vs-general-ipms" class="anchor"></a>Simple IPMs vs General IPMs</h2>
<p>In the <a href="https://levisc8.github.io/ipmr/articles/ipmr-introduction.html">introduction vignette</a>, we reviewed some basic IPM theory and worked through examples of simple IPMs, which only model a single, continuously distributed state variable. General IPMs are distinguished from simple ones in that they incorporate multiple state variables and/or include transitions between continuous and discrete states. These state variables could be, for example, a continuous measure of coral colony surface area and a discrete state to denote aspergillosis infection (in <a href="https://esajournals.onlinelibrary.wiley.com/doi/full/10.1890/09-1178.1">Bruno et al. 2011</a>), a mixture of trees classified by basal diameter and a discrete state for seeds in a seed bank (in <a href="https://besjournals.onlinelibrary.wiley.com/doi/10.1111/1365-2664.13020">Crandall &amp; Knight 2017</a>), or a mixture of multiple continuous and discrete state (e.g. <a href="https://esajournals.onlinelibrary.wiley.com/doi/pdf/10.1890/13-1478.1">Aikens &amp; Roach 2014</a>). A more comprehensive definition is provided in <a href="https://pubmed.ncbi.nlm.nih.gov/16673349/">Ellner &amp; Rees (2006)</a> and in Ellner, Childs &amp; Rees, Chapter 6 (2016).</p>
</div>
<div id="a-general-density-independent-deterministic-ipm" class="section level2">
<h2 class="hasAnchor">
<a href="#a-general-density-independent-deterministic-ipm" class="anchor"></a>A general, density independent, deterministic IPM</h2>
<p>We’ll start with the least complicated of the general IPMs and build progressively from there. If you’ve already read through the introduction vignette, then most of this will look pretty familiar. If not, it is probably best to at least skim the first few sections before proceeding here.</p>
<div id="key-differences-between-simple-and-general-ipms-" class="section level3">
<h3 class="hasAnchor">
<a href="#key-differences-between-simple-and-general-ipms-" class="anchor"></a>Key differences between simple and general IPMs.</h3>
<p>As noted above, we are now working with models that may have multiple continuous state variables and/or discrete states to describe the demography of our species. Thus, we need to add some more information to the model’s definition in order to fully capture these additional demographic details.</p>
<p>Relative to how we define simple models in <code>ipmr</code>, there are now two new bits:</p>
<ol style="list-style-type: decimal">
<li><p>Each kernel that has an integration requires that <code>d_statevariable</code> get appended to the kernel <code>formula</code>. This is equivalent to the “dz” in <span class="math inline">\(\int_L^U K(z',z) n(z,t) \mathrm{dz}\)</span>. <code>ipmr</code> automatically generates this variable internally, so there is no need to define it in the <code>data_list</code> or <code><a href="../reference/define_impl.html">define_domains()</a></code>, we can just add it any of the formula(s) that we want to. We skipped this step in the simple IPMs because it gets appended automatically. Unfortunately, it is less easy to infer the correct state variable to <code>d_z</code> with for general IPMs where there may be many continuous and/or discrete states.</p></li>
<li><p>The implementation arguments list can now have different values in the <code>state_start</code> and <code>state_end</code> slots. This is demonstrated in a separate chunk below.</p></li>
</ol>
</div>
<div id="mathematical-overview-of-the-example" class="section level3">
<h3 class="hasAnchor">
<a href="#mathematical-overview-of-the-example" class="anchor"></a>Mathematical overview of the example</h3>
<p>This example will use an IPM for <em>Ligustrum obtusifolium</em>, a tree species that is now invasive in North America. Data were collected outside of St. Louis, Missouri, and the full model is described in <a href="https://esajournals.onlinelibrary.wiley.com/action/downloadSupplement?doi=10.1002%2Fecy.2681&amp;file=ecy2681-sup-0002-MetadataS1.pdf">Levin et al. 2019</a>. The IPM consists of a single discrete stage (seed bank, abbreviated <code>b</code>) and a single continuous state (height, abbreviated <code>ht</code>/<span class="math inline">\(z,z'\)</span>). Reproduction is time-lagged so all seeds must enter the seed bank. They can either germinate in the next year, or they can die (so <code>stay_discrete</code> = 0). Thus, the full model takes the following form:</p>
<ol style="list-style-type: decimal">
<li><p><span class="math inline">\(n(z', t + 1) = \int_L^U P(z', z) n(z,t)d\mathrm{z} + b(t) * \int_L^U leave\_discrete(z') \mathrm{dz'}\)</span></p></li>
<li><p><span class="math inline">\(b(t + 1) = \int_L^Ugo\_discrete(z) n(z,t)d\mathrm{z}+ stay\_discrete\)</span></p></li>
<li><p><span class="math inline">\(P(z',z) = s(z) * g(z',z)\)</span></p></li>
<li><p><span class="math inline">\(go\_discrete(z) = f_s(z) * f_r(z) * g_i\)</span></p></li>
<li><p><span class="math inline">\(leave\_discrete(z') = e_p * f_d(z')\)</span></p></li>
<li><p><span class="math inline">\(stay\_discrete = 0\)</span></p></li>
</ol>
<p><span class="math inline">\(f_g\)</span> and <span class="math inline">\(f_{r_d}\)</span> denote normal probability density functions. The vital rates functions and example code to fit them are:</p>
<ol style="list-style-type: decimal">
<li>
<p>survival (<code>s</code>): A logistic regression with a squared term</p>
<ul>
<li><p>Example code: <code><a href="https://rdrr.io/r/stats/glm.html">glm(surv ~ ht_1 + I(ht_1)^2, data = my_surv_data, family = binomial())</a></code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(s(z)) = \alpha_s + \beta_{s,1} * z + \beta_{s,2} * z^2\)</span></p></li>
</ul>
</li>
<li>
<p>growth (<code>g</code>): A linear regression</p>
<ul>
<li><p>example code: <code><a href="https://rdrr.io/r/stats/lm.html">lm(ht_2 ~ ht_1, data = grow_data)</a></code></p></li>
<li>
<p>Mathematical form:</p>
<ul>
<li><p><span class="math inline">\(\mu_g = \alpha_g + \beta_g * z\)</span></p></li>
<li><p><span class="math inline">\(g(z',z) = f_g(\mu_g, \sigma_g)\)</span></p></li>
</ul>
</li>
</ul>
</li>
<li>
<p>flowering probability (<code>r_r</code>): A logistic regression</p>
<ul>
<li><p>example code: <code><a href="https://rdrr.io/r/stats/glm.html">glm(repro ~ ht_1, data = my_repro_data, family = binomial())</a></code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(r_r(z)) = \alpha_{r_r} + \beta_{r_r} * z\)</span></p></li>
</ul>
</li>
<li>
<p>seed production (<code>r_s</code>): A Poisson regression</p>
<ul>
<li><p>example code: <code><a href="https://rdrr.io/r/stats/glm.html">glm(seeds ~ ht_1, data = my_seed_data, family = poisson())</a></code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Log(r_s(z)) = \alpha_{r_s} + \beta_{r_s} * z\)</span></p></li>
</ul>
</li>
<li>
<p>Recruit size distribution (<code>r_d</code>): A normal distribution with mean <code>r_d_mu</code> and standard deviation <code>r_d_sd</code>.</p>
<ul>
<li><p>example code: <code>r_d_mu &lt;- mean(my_recr_data$ht_2, na.rm = TRUE)</code> and <code>r_d_sd &lt;- sd(my_rer_data$ht_2, na.rm = TRUE)</code>.</p></li>
<li><p>Mathematical form: <span class="math inline">\(r_d(z') = f_{r_d}(\mu_{r_d}, \sigma_{r_d})\)</span></p></li>
</ul>
</li>
<li>
<p>germination (<code>g_i</code>) and establishment (<code>e_p</code>) are constants. The code below assumes we have our data in long format (each seed get its own row) and that successful germination/establishment is coded as 1s, failures are 0s, and seeds we don’t know the fate of for whatever reason are <code>NA</code>s.</p>
<ul>
<li><p>example code: <code>g_i &lt;- mean(my_germ_data, na.rm = TRUE)</code> and <code>e_p &lt;- mean(my_est_data, na.rm = TRUE)</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(g_i = 0.5067, e_p = 0.15\)</span></p></li>
</ul>
</li>
</ol>
</div>
<div id="model-code" class="section level3">
<h3 class="hasAnchor">
<a href="#model-code" class="anchor"></a>Model code</h3>
<p>Below is the code to implement this model. First, we define our our parameters in a list.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://levisc8.github.io/ipmr/">ipmr</a></span><span class="op">)</span>

<span class="co"># Set up the initial population conditions and parameters</span>

<span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  g_int     <span class="op">=</span> <span class="fl">5.781</span>,
  g_slope   <span class="op">=</span> <span class="fl">0.988</span>,
  g_sd      <span class="op">=</span> <span class="fl">20.55699</span>,
  s_int     <span class="op">=</span> <span class="op">-</span><span class="fl">0.352</span>,
  s_slope   <span class="op">=</span> <span class="fl">0.122</span>,
  s_slope_2 <span class="op">=</span> <span class="op">-</span><span class="fl">0.000213</span>,
  r_r_int   <span class="op">=</span> <span class="op">-</span><span class="fl">11.46</span>,
  r_r_slope <span class="op">=</span> <span class="fl">0.0835</span>,
  r_s_int   <span class="op">=</span> <span class="fl">2.6204</span>,
  r_s_slope <span class="op">=</span> <span class="fl">0.01256</span>,
  r_d_mu    <span class="op">=</span> <span class="fl">5.6655</span>,
  r_d_sd    <span class="op">=</span> <span class="fl">2.0734</span>,
  e_p       <span class="op">=</span> <span class="fl">0.15</span>,
  g_i       <span class="op">=</span> <span class="fl">0.5067</span>
<span class="op">)</span></code></pre></div>
<p>Next, we set up two functions to pass into the model. These perform the inverse logit transformations for the probability of flowering model (<code>r_r</code>/<span class="math inline">\(r_r(z)\)</span>) and survival model (<code>s</code>/<span class="math inline">\(s(z)\)</span>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># We'll set up some helper functions. The survival function</span>
<span class="co"># in this model is a quadratic function, so we use an additional inverse logit function</span>
<span class="co"># that can handle the quadratic term.</span>

<span class="va">inv_logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span>
  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">inv_logit_2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">slope_2</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span>
  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">+</span> <span class="va">slope_2</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Now, we’re ready to begin making the IPM kernels. We change the <code>sim_gen</code> argument of <code><a href="../reference/init_ipm.html">init_ipm()</a></code> to <code>"general"</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">general_ipm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init_ipm.html">init_ipm</a></span><span class="op">(</span>sim_gen <span class="op">=</span> <span class="st">"general"</span>, di_dd <span class="op">=</span> <span class="st">"di"</span>, det_stoch <span class="op">=</span> <span class="st">"det"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name          <span class="op">=</span> <span class="st">"P"</span>,
    
    <span class="co"># We add d_ht to formula to make sure integration is handled correctly.</span>
    <span class="co"># This variable is generated internally by make_ipm(), so we don't need</span>
    <span class="co"># to do anything else.</span>
    
    formula       <span class="op">=</span> <span class="va">s</span> <span class="op">*</span> <span class="va">g</span> <span class="op">*</span> <span class="va">d_ht</span>,
    
    <span class="co"># The family argument tells ipmr what kind of transition this kernel describes.</span>
    <span class="co"># it can be "CC" for continuous -&gt; continuous, "DC" for discrete -&gt; continuous</span>
    <span class="co"># "CD" for continuous -&gt; discrete, or "DD" for discrete -&gt; discrete.</span>
    
    family        <span class="op">=</span> <span class="st">"CC"</span>,
    
    <span class="co"># The rest of the arguments are exactly the same as in the simple models</span>
    
    g             <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">g_mu</span>, <span class="va">g_sd</span><span class="op">)</span>,
    g_mu          <span class="op">=</span> <span class="va">g_int</span> <span class="op">+</span> <span class="va">g_slope</span> <span class="op">*</span> <span class="va">ht_1</span>,
    s             <span class="op">=</span> <span class="fu">inv_logit_2</span><span class="op">(</span><span class="va">s_int</span>, <span class="va">s_slope</span>, <span class="va">s_slope_2</span>, <span class="va">ht_1</span><span class="op">)</span>,
    data_list     <span class="op">=</span> <span class="va">data_list</span>,
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>,
    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,
    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,
                                            <span class="st">'g'</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name          <span class="op">=</span> <span class="st">"go_discrete"</span>,
    formula       <span class="op">=</span> <span class="va">r_r</span> <span class="op">*</span> <span class="va">r_s</span> <span class="op">*</span> <span class="va">g_i</span> <span class="op">*</span> <span class="va">d_ht</span>,
    
    <span class="co"># Note that now, family = "CD" because it denotes a continuous -&gt; discrete transition</span>
    
    family        <span class="op">=</span> <span class="st">'CD'</span>,
    r_r           <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">r_r_int</span>, <span class="va">r_r_slope</span>, <span class="va">ht_1</span><span class="op">)</span>,
    r_s           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">r_s_int</span> <span class="op">+</span> <span class="va">r_s_slope</span> <span class="op">*</span> <span class="va">ht_1</span><span class="op">)</span>,
    data_list     <span class="op">=</span> <span class="va">data_list</span>,
    
    <span class="co"># Note that here, we add "b" to our list in states, because this kernel</span>
    <span class="co"># "creates" seeds entering the seedbank</span>
    
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name    <span class="op">=</span> <span class="st">'stay_discrete'</span>,
    
    <span class="co"># In this case, seeds in the seed bank either germinate or die, but they </span>
    <span class="co"># do not remain for multiple time steps. This can be adjusted as needed.</span>
    
    formula <span class="op">=</span> <span class="fl">0</span>,
    
    <span class="co"># Note that now, family = "DD" becuase it denotes a discrete -&gt; discrete transition</span>
    
    family  <span class="op">=</span> <span class="st">"DD"</span>,
    
    <span class="co"># The only state variable this operates on is "b", so we can leave "ht"</span>
    <span class="co"># out of the states list</span>
    
    states  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'b'</span><span class="op">)</span><span class="op">)</span>,
    evict_cor <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    
    <span class="co"># Here, the family changes to "DC" because it is the discrete -&gt; continuous </span>
    <span class="co"># transition</span>
    
    name          <span class="op">=</span> <span class="st">'leave_discrete'</span>,
    
    <span class="co"># We append d_ht here as well, because we need to integrate over the </span>
    <span class="co"># the recruit size distribution.</span>
    
    formula       <span class="op">=</span> <span class="va">e_p</span> <span class="op">*</span> <span class="va">r_d</span> <span class="op">*</span> <span class="va">d_ht</span>,
    r_d           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">r_d_mu</span>, <span class="va">r_d_sd</span><span class="op">)</span>,
    family        <span class="op">=</span> <span class="st">'DC'</span>,
    data_list     <span class="op">=</span> <span class="va">data_list</span>,
    
    <span class="co"># Again, we need to add "b" to the states list</span>
    
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>,
    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,
    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,
                                            <span class="st">'r_d'</span><span class="op">)</span>
  <span class="op">)</span> </code></pre></div>
<p>We’ve now defined all of the kernels, next are the implementation details. These also differ somewhat from simple IPMs. The key difference in the implementation arguments list lies in the <code>state_start</code> and <code>state_end</code> of each kernel, and is related to the <code>family</code> argument of each kernel. Kernels that begin with one state and end in a different state (e.g. moving from seed bank to a plant) will have different entries in the <code>state_start</code> and <code>state_end</code> slots. It is very important to get these correct, as <code>ipmr</code> uses this information to generate the model iteration procedure automatically (i.e. code corresponding to Equations 1-2).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">general_ipm</span> <span class="op">&lt;-</span> <span class="va">general_ipm</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_impl</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      P              <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>int_rule    <span class="op">=</span> <span class="st">"midpoint"</span>,
                            state_start <span class="op">=</span> <span class="st">"ht"</span>,
                            state_end   <span class="op">=</span> <span class="st">"ht"</span><span class="op">)</span>,
      go_discrete    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>int_rule    <span class="op">=</span> <span class="st">"midpoint"</span>,
                            state_start <span class="op">=</span> <span class="st">"ht"</span>,
                            state_end   <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,
      stay_discrete  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>int_rule    <span class="op">=</span> <span class="st">"midpoint"</span>,
                            state_start <span class="op">=</span> <span class="st">"b"</span>,
                            state_end   <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,
      leave_discrete <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>int_rule    <span class="op">=</span> <span class="st">"midpoint"</span>,
                            state_start <span class="op">=</span> <span class="st">"b"</span>,
                            state_end   <span class="op">=</span> <span class="st">"ht"</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p>An alternative to the list above is to use <code><a href="../reference/define_impl.html">make_impl_args_list()</a></code>. The chunk above and the chunk below generate equivalent <code>proto_ipm</code> objects.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">general_ipm</span> <span class="op">&lt;-</span> <span class="va">general_ipm</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_impl</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/define_impl.html">make_impl_args_list</a></span><span class="op">(</span>
      kernel_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"P"</span>, <span class="st">"go_discrete"</span>, <span class="st">"stay_discrete"</span>, <span class="st">"leave_discrete"</span><span class="op">)</span>,
      int_rule     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"midpoint"</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,
      state_start    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"ht"</span>, <span class="st">"b"</span>, <span class="st">"b"</span><span class="op">)</span>,
      state_end      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">'ht'</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p>The rest is the same as the simple IPM. We can use our pre-defined functions in <code>make_ipm</code>, and we can use pre-defined variables in <code>define_domains</code>. We’ll create variables for the upper (<code>U</code>) and lower (<code>L</code>) size bounds for the population, and the number of meshpoints for integration (<code>n</code>). We also define initial population vectors for both <code>b</code> and <code>ht</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># The lower and upper bounds for the continuous state variable and the number</span>
<span class="co"># of meshpoints for the midpoint rule integration. We'll also create the initial</span>
<span class="co"># population vector from a random uniform distribution</span>

<span class="va">L</span> <span class="op">&lt;-</span> <span class="fl">1.02</span>
<span class="va">U</span> <span class="op">&lt;-</span> <span class="fl">624</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2312</span><span class="op">)</span>

<span class="va">init_pop_vec</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span>
<span class="va">init_seed_bank</span> <span class="op">&lt;-</span> <span class="fl">20</span>


<span class="va">general_ipm</span> <span class="op">&lt;-</span> <span class="va">general_ipm</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_domains</a></span><span class="op">(</span>
    
    <span class="co"># We can pass the variables we created above into define_domains</span>
    
    ht <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">L</span>, <span class="va">U</span>, <span class="va">n</span><span class="op">)</span>
    
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_pop_state</a></span><span class="op">(</span>
    
    <span class="co"># We can also pass them into define_pop_state</span>
    
    pop_vectors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      n_ht <span class="op">=</span> <span class="va">init_pop_vec</span>,
      n_b  <span class="op">=</span> <span class="va">init_seed_bank</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/make_ipm.html">make_ipm</a></span><span class="op">(</span>iterations <span class="op">=</span> <span class="fl">100</span>,
           usr_funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>inv_logit   <span class="op">=</span> <span class="va">inv_logit</span>,
                           inv_logit_2 <span class="op">=</span> <span class="va">inv_logit_2</span><span class="op">)</span><span class="op">)</span>


<span class="co"># lambda is a generic function to compute per-capita growth rates. It has a number</span>
<span class="co"># of different options depending on the type of model</span>

<span class="fu"><a href="../reference/lambda.html">lambda</a></span><span class="op">(</span><span class="va">general_ipm</span><span class="op">)</span>

<span class="co"># If we are worried about whether or not the model converged to stable</span>
<span class="co"># dynamics, we can use the exported utility is_conv_to_asymptotic. The default</span>
<span class="co"># tolerance for convergence is 1e-10, but can be changed with the 'tol' argument.</span>

<span class="fu"><a href="../reference/is_conv_to_asymptotic.html">is_conv_to_asymptotic</a></span><span class="op">(</span><span class="va">general_ipm</span>, tol <span class="op">=</span> <span class="fl">1e-10</span><span class="op">)</span>

<span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/right_ev.html">right_ev</a></span><span class="op">(</span><span class="va">general_ipm</span><span class="op">)</span>
<span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/right_ev.html">left_ev</a></span><span class="op">(</span><span class="va">general_ipm</span><span class="op">)</span></code></pre></div>
<p>Our model is now built! We can explore the asymptotic population growth rate with the <code><a href="../reference/lambda.html">lambda()</a></code> function, which will work on any object made my <code><a href="../reference/make_ipm.html">make_ipm()</a></code>. The same is true for <code><a href="../reference/is_conv_to_asymptotic.html">is_conv_to_asymptotic()</a></code>, which is a helper to function to figure out if we’ve set the number of <code>iterations</code> high enough to actually reach asymptotic population dynamics. <code>left_ev</code> and <code>right_ev</code> work for general deterministic IPMs as well. Stochastic versions are in the works, but are not yet implemented.</p>
</div>
<div id="further-analysis" class="section level3">
<h3 class="hasAnchor">
<a href="#further-analysis" class="anchor"></a>Further analysis</h3>
<p>Say we wanted to calculate the mean and variance of life span conditional on initial state <span class="math inline">\(z_0\)</span>. This requires us to generate the IPM’s fundamental operator, <span class="math inline">\(N\)</span>, which is computed as follows: <span class="math inline">\(N = (I - P)^{-1}\)</span>. The following chunk is a function to compute average lifespan as a function of initial size. Note that we omit the fecundity from these calculations entirely, as our model does not assume that reproduction imposes a cost on survival.</p>
<p>The formula for mean lifespan is given as <span class="math inline">\(\bar{\eta}(z_0) = eN\)</span> (where <span class="math inline">\(e\)</span> is a constant function such that <span class="math inline">\(e(z)\equiv1\)</span>), and the formula for its variance is <span class="math inline">\(\sigma^2_\eta(z_0) = e(2N^2-N) - (eN)^2\)</span>. Since the <span class="math inline">\(e\)</span> function has the effect of summing columns, we’ll replace that with the <em>R</em> function <code>colSums</code>. Our second function, <code>sigma_eta</code>, will make use of <code><a href="../reference/%%5E%.html">%^%</a></code> from <code>ipmr</code>, which multiples matrices by themselves, rather than the point-wise power provided by <code><a href="https://rdrr.io/r/base/Arithmetic.html">^</a></code>. More details on the math underlying these calculations are provided in Ellner, Childs, &amp; Rees (2016), chapter 3.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">make_N</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">P</span>     <span class="op">&lt;-</span> <span class="va">ipm</span><span class="op">$</span><span class="va">sub_kernels</span><span class="op">$</span><span class="va">P</span>
  
  <span class="va">I</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">P</span><span class="op">)</span><span class="op">)</span>
  <span class="va">N</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">I</span> <span class="op">-</span> <span class="va">P</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">eta_bar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">N</span>     <span class="op">&lt;-</span> <span class="fu">make_N</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span>
  <span class="va">out</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span>
  
<span class="op">}</span>

<span class="va">sigma_eta</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">N</span>     <span class="op">&lt;-</span> <span class="fu">make_N</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span>  

  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">N</span> <span class="op">%^%</span> <span class="fl">2L</span> <span class="op">-</span> <span class="va">N</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">mean_l</span> <span class="op">&lt;-</span> <span class="fu">eta_bar</span><span class="op">(</span><span class="va">general_ipm</span><span class="op">)</span>
<span class="va">var_l</span>  <span class="op">&lt;-</span> <span class="fu">sigma_eta</span><span class="op">(</span><span class="va">general_ipm</span><span class="op">)</span>

<span class="va">mesh_ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/domains.html">int_mesh</a></span><span class="op">(</span><span class="va">general_ipm</span><span class="op">)</span><span class="op">$</span><span class="va">ht_1</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mesh_ps</span>, <span class="va">mean_l</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span> <span class="st">"Initial size z"</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mesh_ps</span>, <span class="va">var_l</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span> <span class="st">"Initial size z"</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>From prior knowledge, we happen to know that even in the best conditions, <em>Ligustrum obtusifolium</em> individuals usually only live 25-50 years. It appears that our model (wildly) overestimates their average lifespan, and we’d want to think about how to re-parameterize it to more accurately capture mortality events. Our survival model would seem the most likely candidate for re-examination, particularly for young and mid-sized trees. That is a problem for another day though, and so the next section will investigate how to implement general IPMs in discretely varying environments.</p>
</div>
</div>
<div id="general-models-for-discretely-varying-environments" class="section level2">
<h2 class="hasAnchor">
<a href="#general-models-for-discretely-varying-environments" class="anchor"></a>General models for discretely varying environments</h2>
<p>Discretely varying parameters can be used to construct general IPMs with little additional effort. These are typically the result of fitting a set of fixed effects vital rate models that include both continuous predictors for size/state and categorical variables like treatment or maturation state. They can also result from mixed effects models, for example, working with conditional modes for a random intercept corresponding to year or site.</p>
<p>If you’ve already read the Intro to <code>ipmr</code> article and the example above, then there aren’t any new concepts to introduce here. Below is an example showing how all of these come together.</p>
<div id="mathematical-overview-of-the-example-1" class="section level3">
<h3 class="hasAnchor">
<a href="#mathematical-overview-of-the-example-1" class="anchor"></a>Mathematical overview of the example</h3>
<p>We’ll use a variation of the model above, simulating some random year-specific intercepts for growth and seed production. Parameters, functions, and kernels that are now time varying have a superscript, <span class="math inline">\(yr\)</span> appended to them.</p>
<ol style="list-style-type: decimal">
<li><p><span class="math inline">\(n(z', t + 1) = \int_L^U P^{yr}(z', z) n(z,t)d\mathrm{z} + b(t) * \int_L^U leave\_discrete(z') \mathrm{dz'}\)</span></p></li>
<li><p><span class="math inline">\(b(t + 1) = \int_L^Ugo\_discrete^{yr}(z) n(z,t)d\mathrm{z}+ stay\_discrete\)</span></p></li>
<li><p><span class="math inline">\(P^{yr}(z',z) = s(z) * g^{yr}(z',z)\)</span></p></li>
<li><p><span class="math inline">\(go\_discrete^{yr}(z) = r_s^{yr}(z) * r_r(z) * g_i\)</span></p></li>
<li><p><span class="math inline">\(leave\_discrete(z') = e_p * r_d(z')\)</span></p></li>
<li><p><span class="math inline">\(stay\_discrete = 0\)</span></p></li>
</ol>
<p>The vital rate models are as follows:</p>
<ol style="list-style-type: decimal">
<li>
<p>survival (<code>s</code>): A logistic regression</p>
<ul>
<li><p>Example code: <code><a href="https://rdrr.io/r/stats/glm.html">glm(surv ~ ht_1, data = my_surv_data, family = binomial())</a></code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(s(z)) = \alpha_s + \beta_{s,1} * z + \beta_{s,2} * z^2\)</span></p></li>
</ul>
</li>
<li>
<p>growth (<code>g</code>): A linear mixed effects regression. <span class="math inline">\(f_g\)</span> denotes a normal probability density function.</p>
<ul>
<li><p>example code: <code>lmer(ht_2 ~ ht_1 + (1 | year), data = grow_data)</code></p></li>
<li>
<p>Mathematical form:</p>
<ul>
<li><p><span class="math inline">\(\mu_g^{yr} = \alpha_g + \alpha_{g}^{yr} + \beta_g * z\)</span></p></li>
<li><p><span class="math inline">\(g^{yr}(z',z) = f_g(\mu_g^{yr}, \sigma_g)\)</span></p></li>
</ul>
</li>
</ul>
</li>
<li>
<p>flowering probability (<code>r_r</code>): A logistic regression</p>
<ul>
<li><p>example code: <code><a href="https://rdrr.io/r/stats/glm.html">glm(repro ~ ht_1, data = my_repro_data, family = binomial())</a></code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(r_r(z)) = \alpha_{r_r} + \beta_{r_r} * z\)</span></p></li>
</ul>
</li>
<li>
<p>seed production (<code>r_s</code>): A Poisson mixed effects regression</p>
<ul>
<li><p>example code: <code>glmer(seeds ~ ht_1 + (1 | year), data = my_seed_data, family = poisson())</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Log(r_s^{yr}(z)) = \alpha_{r_s} + \alpha_{r_s}^{yr} + \beta_{r_s} * z\)</span></p></li>
</ul>
</li>
<li>
<p>Recruit size distribution (<code>r_d</code>): A normal distribution (<span class="math inline">\(f_{r_d}\)</span>) with mean <code>r_d_mu</code> and standard deviation <code>r_d_sd</code>.</p>
<ul>
<li><p>example code: <code>r_d_mu &lt;- mean(my_recr_data$ht_2, na.rm = TRUE)</code> and <code>r_d_sd &lt;- sd(my_recr_data$ht_2, na.rm = TRUE)</code>.</p></li>
<li><p>Mathematical form: <span class="math inline">\(r_d(z') = f_{r_d}(\mu_{r_d}, \sigma_{r_d})\)</span></p></li>
</ul>
</li>
<li>
<p>germination (<code>g_i</code>) and establishment (<code>e_p</code>) are constants. The code below assumes we have our data in long format (each seed get its own row) and that successful germinations/establishments are coded as 1s, failures are 0s, and seeds we don’t know the fate of for whatever reason are <code>NA</code>s.</p>
<ul>
<li><p>example code: <code>g_i &lt;- mean(my_germ_data, na.rm = TRUE)</code> and <code>e_p &lt;- mean(my_est_data, na.rm = TRUE)</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(g_i = 0.5067, e_p = 0.15\)</span></p></li>
</ul>
</li>
</ol>
</div>
<div id="model-parameterization" class="section level3">
<h3 class="hasAnchor">
<a href="#model-parameterization" class="anchor"></a>Model parameterization</h3>
<p>In the next chunk, we’ll set up the data list with all of our constants and make sure the names are what we want them to be. This example generates intercepts for 5 years of data. This can be altered according to your own needs. Then, we’ll define a couple functions to make the vital rate expressions easier to write.</p>
<p>A key aspect here is setting the names on the time-varying parameters in the <code>data_list</code>. We are using the form <code>"g_int_year"</code>, and substituting the values that <code>"year"</code> can take in for the actual suffix. These don’t need to be numbers, they can be words, letters, or some combination of the two. For this example, the years will be represented with the values <code>1:5</code>. If we wanted to denote the actual years of the censuses, we could switch <code>1:5</code> to, for example, <code>2002:2006</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://levisc8.github.io/ipmr/">ipmr</a></span><span class="op">)</span>

<span class="co"># Set up the initial population conditions and parameters</span>
<span class="co"># Here, we are simulating random intercepts for growth</span>
<span class="co"># and seed production, converting them to a list,</span>
<span class="co"># and adding them into the list of constants. Equivalent code</span>
<span class="co"># to produce the output for the output from lmer/glmer</span>
<span class="co"># is in the comments next to each line</span>

<span class="va">all_g_int</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, mean <span class="op">=</span> <span class="fl">5.781</span>, sd <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> <span class="co"># as.list(unlist(ranef(my_growth_model)))</span>
<span class="va">all_r_s_int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, mean <span class="op">=</span> <span class="fl">2.6204</span>, sd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="co"># as.list(unlist(ranef(my_seed_model)))</span>


<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">all_g_int</span><span class="op">)</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"g_int_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">all_r_s_int</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"r_s_int_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>

<span class="va">constant_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  g_slope   <span class="op">=</span> <span class="fl">0.988</span>,
  g_sd      <span class="op">=</span> <span class="fl">20.55699</span>,
  s_int     <span class="op">=</span> <span class="op">-</span><span class="fl">0.352</span>,
  s_slope   <span class="op">=</span> <span class="fl">0.122</span>,
  s_slope_2 <span class="op">=</span> <span class="op">-</span><span class="fl">0.000213</span>,
  r_r_int   <span class="op">=</span> <span class="op">-</span><span class="fl">11.46</span>,
  r_r_slope <span class="op">=</span> <span class="fl">0.0835</span>,
  r_s_slope <span class="op">=</span> <span class="fl">0.01256</span>,
  r_d_mu    <span class="op">=</span> <span class="fl">5.6655</span>,
  r_d_sd    <span class="op">=</span> <span class="fl">2.0734</span>,
  e_p       <span class="op">=</span> <span class="fl">0.15</span>,
  g_i       <span class="op">=</span> <span class="fl">0.5067</span>
<span class="op">)</span>

<span class="va">all_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">constant_list</span>, <span class="va">all_g_int</span>, <span class="va">all_r_s_int</span><span class="op">)</span>

<span class="co"># The lower and upper bounds for the continuous state variable and the number</span>
<span class="co"># of meshpoints for the midpoint rule integration.</span>

<span class="va">L</span> <span class="op">&lt;-</span> <span class="fl">1.02</span>
<span class="va">U</span> <span class="op">&lt;-</span> <span class="fl">624</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2312</span><span class="op">)</span>

<span class="va">init_pop_vec</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span>
<span class="va">init_seed_bank</span> <span class="op">&lt;-</span> <span class="fl">20</span>

<span class="co"># add some helper functions. The survival function</span>
<span class="co"># in this model is a quadratic function, so we use an additional inverse logit function</span>
<span class="co"># that can handle the quadratic term.</span>

<span class="va">inv_logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span>
  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">inv_logit_2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">slope_2</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span>
  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">+</span> <span class="va">slope_2</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Next, we will set up our sub-kernels. We’ll append the <code>_year</code> suffix to the kernel <code>name</code>, the vital rate expressions and parameter values that have time-varying components (<code>g_year</code>, <code>f_s_year</code>, <code>g_int_year</code>, <code>f_s_int_year</code>), and the call to <code>truncated_distributions</code> so that the growth kernel is correctly specified. We’ll also pass a <code>list(year = 1:5))</code> into the <code>levels_hier_effs</code> argument of <code><a href="../reference/define_kernel.html">define_kernel()</a></code>. When building the model, <code><a href="../reference/make_ipm.html">make_ipm()</a></code> automatically expands these expressions to create 5 different expressions containing the various levels of <code>year</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">general_stoch_kern_ipm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init_ipm.html">init_ipm</a></span><span class="op">(</span>sim_gen    <span class="op">=</span> <span class="st">"general"</span>,
                                   di_dd      <span class="op">=</span> <span class="st">"di"</span>, 
                                   det_stoch  <span class="op">=</span> <span class="st">"stoch"</span>,
                                   kern_param <span class="op">=</span> <span class="st">"kern"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    
    <span class="co"># The kernel name gets a _year added to it to denote that there</span>
    <span class="co"># are multiple possible kernels we can build with our parameter set.</span>
    <span class="co"># The _year gets substituted by the names of the possible levels in the </span>
    <span class="co"># output, so in this example we will have P_1, P_2, P_3, P_4, and P_5</span>
    
    name          <span class="op">=</span> <span class="st">"P_year"</span>,
    
    <span class="co"># We also add _year to "g" to signify that it is going to vary across kernels.</span>
    
    formula       <span class="op">=</span> <span class="va">s</span> <span class="op">*</span> <span class="va">g_year</span> <span class="op">*</span> <span class="va">d_ht</span>,
    family        <span class="op">=</span> <span class="st">"CC"</span>,
    
    <span class="co"># Here, we add the suffixes again, ensuring they are expanded and replaced</span>
    <span class="co"># during model building by the parameter names</span>
    
    g_year           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">g_mu_year</span>, <span class="va">g_sd</span><span class="op">)</span>,
    g_mu_year        <span class="op">=</span> <span class="va">g_int_year</span> <span class="op">+</span> <span class="va">g_slope</span> <span class="op">*</span> <span class="va">ht_1</span>,
    s                <span class="op">=</span> <span class="fu">inv_logit_2</span><span class="op">(</span><span class="va">s_int</span>, <span class="va">s_slope</span>, <span class="va">s_slope_2</span>, <span class="va">ht_1</span><span class="op">)</span>,
    data_list        <span class="op">=</span> <span class="va">all_params</span>,
    states           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span><span class="op">)</span><span class="op">)</span>,
    
    <span class="co"># We set has_hier_effs to TRUE, signalling that we want to expand these</span>
    <span class="co"># expressions across all levels of levels_hier_effs.</span>
    
    has_hier_effs    <span class="op">=</span> <span class="cn">TRUE</span>,
    levels_hier_effs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>,
    evict_cor        <span class="op">=</span> <span class="cn">TRUE</span>,
    
    <span class="co"># we also add the suffix to `target` here, because the value modified by </span>
    <span class="co"># truncated_distributions is time-varying.</span>
    
    evict_fun        <span class="op">=</span> <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,
                                               target <span class="op">=</span> <span class="st">'g_year'</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    
    <span class="co"># again, we append the suffix to the kernel name, vital rate expressions,</span>
    <span class="co"># and in the model formula.</span>
    
    name          <span class="op">=</span> <span class="st">"go_discrete_year"</span>,
    formula       <span class="op">=</span> <span class="va">r_r</span> <span class="op">*</span> <span class="va">r_s_year</span> <span class="op">*</span> <span class="va">g_i</span> <span class="op">*</span> <span class="va">d_ht</span>,
    family        <span class="op">=</span> <span class="st">'CD'</span>,
    r_r           <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">r_r_int</span>, <span class="va">r_r_slope</span>, <span class="va">ht_1</span><span class="op">)</span>,
    
    <span class="co"># Again, we modify the left and right hand side of this expression to </span>
    <span class="co"># show that there is a time-varying component</span>
    
    r_s_year      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">r_s_int_year</span> <span class="op">+</span> <span class="va">r_s_slope</span> <span class="op">*</span> <span class="va">ht_1</span><span class="op">)</span>,
    data_list     <span class="op">=</span> <span class="va">all_params</span>,
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs    <span class="op">=</span> <span class="cn">TRUE</span>,
    levels_hier_effs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    
    <span class="co"># This kernel has no time-varying parameters, and so does not require a suffix</span>
    <span class="co"># appended to it.</span>
    
    name    <span class="op">=</span> <span class="st">'stay_discrete'</span>,
    
    <span class="co"># In this case, seeds in the seed bank either germinate or die, but they </span>
    <span class="co"># do not remain for multipe time steps. This can be adjusted as needed.</span>
    
    formula <span class="op">=</span> <span class="fl">0</span>,
    
    <span class="co"># Note that now, family = "DD" becuase it denotes a discrete -&gt; discrete transition</span>
    
    family  <span class="op">=</span> <span class="st">"DD"</span>,
    states  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'b'</span><span class="op">)</span><span class="op">)</span>,
    
    <span class="co"># This kernel has no time-varying parameters, so we don't need to designate</span>
    <span class="co"># it as such.</span>
    
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>,
    evict_cor <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>

    <span class="co"># This kernel also doesn't get a suffix, because there are no varying parameters.</span>
    
    name          <span class="op">=</span> <span class="st">'leave_discrete'</span>,
    formula       <span class="op">=</span> <span class="va">e_p</span> <span class="op">*</span> <span class="va">r_d</span> <span class="op">*</span> <span class="va">d_ht</span>,
    r_d           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">r_d_mu</span>, <span class="va">r_d_sd</span><span class="op">)</span>,
    family        <span class="op">=</span> <span class="st">'DC'</span>,
    data_list     <span class="op">=</span> <span class="va">all_params</span>,
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>,
    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,
    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,
                                            <span class="st">'r_d'</span><span class="op">)</span>
  <span class="op">)</span>  <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_impl</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/define_impl.html">make_impl_args_list</a></span><span class="op">(</span>
      
      <span class="co"># We add suffixes to the kernel names here to make sure they match the names</span>
      <span class="co"># we specified above.</span>
      
      kernel_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"P_year"</span>, <span class="st">"go_discrete_year"</span>, <span class="st">"stay_discrete"</span>, <span class="st">"leave_discrete"</span><span class="op">)</span>,
      int_rule     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"midpoint"</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,
      state_start    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"ht"</span>, <span class="st">"b"</span>, <span class="st">"b"</span><span class="op">)</span>,
      state_end      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">'ht'</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_domains</a></span><span class="op">(</span>
    ht <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">L</span>, <span class="va">U</span>, <span class="va">n</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_pop_state</a></span><span class="op">(</span>
      n_ht <span class="op">=</span> <span class="va">init_pop_vec</span>,
      n_b  <span class="op">=</span> <span class="va">init_seed_bank</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/make_ipm.html">make_ipm</a></span><span class="op">(</span>
    iterations <span class="op">=</span> <span class="fl">100</span>,
    
    <span class="co"># We can specify a sequence of kernels to select for the simulation.</span>
    <span class="co"># This helps others to reproduce what we did,</span>
    <span class="co"># and lets us keep track of the consequences of different selection</span>
    <span class="co"># sequences for population dynamics. </span>
    
    kernel_seq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, size <span class="op">=</span> <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    usr_funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>inv_logit   <span class="op">=</span> <span class="va">inv_logit</span>,
                    inv_logit_2 <span class="op">=</span> <span class="va">inv_logit_2</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p>100 isn’t too many iterations, but hopefully this demonstrates how to set up and implement such a model. There are a number of slots in the output that may be useful for further analyses.</p>
<ol style="list-style-type: decimal">
<li><p><code>env_seq</code>: This contains a character vector which shows the sequence in which levels of the time-varying components were chosen during model iteration. We could use this reproduce the model outputs later.</p></li>
<li><p><code>pop_state$lambda</code>: This shows the single timestep per-capita growth rates for the simulation.</p></li>
</ol>
<p>Additionally, there are functions to compute the stochastic population growth rate (<span class="math inline">\(\lambda_s\)</span>, computed as <code><a href="https://rdrr.io/r/base/mean.html">mean(log(pop_state$lambda))</a></code> with the first 10% of iterations removed as burn-in), and the mean sub-kernels.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mean_kernels</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mean_kernel.html">mean_kernel</a></span><span class="op">(</span><span class="va">general_stoch_kern_ipm</span><span class="op">)</span>
<span class="va">lam_s</span>        <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lambda.html">lambda</a></span><span class="op">(</span><span class="va">general_stoch_kern_ipm</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="general-models-with-continuously-varying-environments" class="section level2">
<h2 class="hasAnchor">
<a href="#general-models-with-continuously-varying-environments" class="anchor"></a>General models with continuously varying environments</h2>
<p>We can also use continuously varying parameters to construct general IPMs. These are good tools for exploring the consequences of environmental variation on demographic rates. <code>ipmr</code> handles these using <code><a href="../reference/define_impl.html">define_env_state()</a></code>, which can take both functions and data and generate draws from distributions during each iteration of the model.</p>
<div id="mathematical-overview" class="section level3">
<h3 class="hasAnchor">
<a href="#mathematical-overview" class="anchor"></a>Mathematical overview</h3>
<p>This example includes survival and growth models that make use of environmental covariates. The model can be written as:</p>
<ol style="list-style-type: decimal">
<li><p><span class="math inline">\(n(z', t+1) = \int_L^U K(z',z, \theta)n(z,t)dz + B(t) * r_s * r_d * \int_L^Uf_d(z')dz'\)</span></p></li>
<li><p><span class="math inline">\(B(t + 1) = r_e * r_s * \int_L^U c_r(z) * c_s(z)n(z,t)dz + B(t) * r_s * r_r\)</span></p></li>
<li><p><span class="math inline">\(K(z',z,\theta) = P(z',z,\theta) + F(z',z)\)</span></p></li>
<li><p><span class="math inline">\(P(z',z,\theta) = s(z, \theta) * g(z',z,\theta)\)</span></p></li>
<li><p><span class="math inline">\(F(z',z) = c_r(z) * c_s(z) * c_d(z') * (1 - r_e)\)</span></p></li>
</ol>
<p><span class="math inline">\(\theta\)</span> is a vector of time-varying environmental parameters. For this example, we’ll use a Gaussian distribution for temperature and a Gamma distribution for precipitation:</p>
<ol start="6" style="list-style-type: decimal">
<li><p><span class="math inline">\(\theta_t \sim Norm(\mu = 8.9, \sigma = 1.2)\)</span></p></li>
<li><p><span class="math inline">\(\theta_p \sim Gamma(k = 1000, \beta = 2)\)</span></p></li>
</ol>
<p>Next, we’ll write out the actual vital rate functions in the model:</p>
<ol start="8" style="list-style-type: decimal">
<li>
<p>survival (<code>s</code>/<span class="math inline">\(s(z,\theta)\)</span>): a logistic regression.</p>
<ul>
<li><p>Example model formula: <code><a href="https://rdrr.io/r/stats/glm.html">glm(survival ~ size_1 + temp + precip, data = my_surv_data, family = binomial())</a></code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(s(z,\theta)) = \alpha_s + \beta_s^z * z + \beta_s^t * temp + \beta_s^p * precip\)</span></p></li>
</ul>
</li>
<li>
<p>growth (<code>g</code>, <span class="math inline">\(g(z',z,\theta)\)</span>): a linear regression</p>
<ul>
<li><p>Example model formula: <code><a href="https://rdrr.io/r/stats/glm.html">glm(size_2 ~ size_1 + temp + precip, data = my_grow_data)</a></code></p></li>
<li>
<p>Mathematical form:</p>
<ul>
<li><p><span class="math inline">\(g(z',z) = f_g(\mu_g(z,\theta), \sigma_g)\)</span></p></li>
<li><p><span class="math inline">\(\mu_g(z, \theta) = \alpha_g + \beta_g^z * z + \beta_g^t * temp + \beta_g^p * precip\)</span></p></li>
</ul>
</li>
</ul>
</li>
<li>
<p>flower probability (<code>c_r</code>/<span class="math inline">\(c_r(z)\)</span>): A logistic regression.</p>
<ul>
<li><p>Example model formula: <code><a href="https://rdrr.io/r/stats/glm.html">glm(repro ~ size_1, data = my_repro_data, family = binomial())</a></code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(c_r(z)) = \alpha_{c} + \beta_{c_r} * z\)</span></p></li>
</ul>
</li>
<li>
<p>seed production (<code>c_s</code>/<span class="math inline">\(c_s(z)\)</span>: a logistic regression.</p>
<ul>
<li><p>Example model formula: <code><a href="https://rdrr.io/r/stats/glm.html">glm(flower_n ~ size_1, data = my_flower_data, family = poisson())</a></code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Log(c_s(z)) = \alpha_{c_s} + \beta_{c_s} * z\)</span></p></li>
</ul>
</li>
<li>
<p>recruit sizes (<code>c_d</code>/<span class="math inline">\(c_d(z')\)</span>): A normal distribution (denoted <span class="math inline">\(f_{c_d}\)</span>)</p>
<ul>
<li><p>Example code: mean (<code>c_d_mu</code>) <code><a href="https://rdrr.io/r/base/mean.html">mean(my_recruit_data$size_2, na.rm = TRUE)</a></code> and standard deviation (<code>c_d_sd</code>) <code><a href="https://rdrr.io/r/stats/sd.html">sd(my_recruit_data$size_2, na.rm = TRUE)</a></code></p></li>
<li><p>Mathematical form: <span class="math inline">\(c_d(z') = f_{c_d}(\mu_{f_d}, \sigma_{f_d})\)</span></p></li>
</ul>
</li>
<li><p>Constants: Discrete stage survival (<code>r_s</code>), discrete stage entrance probability (<code>r_e</code>), discrete stage departure probability conditional on survival (<code>r_d</code>), and probability of remaining in discrete stage (<code>r_r</code>).</p></li>
</ol>
</div>
<div id="model-parameterization-1" class="section level3">
<h3 class="hasAnchor">
<a href="#model-parameterization-1" class="anchor"></a>Model parameterization</h3>
<p>First, we’ll specify the constant parameters. We keep all values related to demography in the <code>data_list</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://levisc8.github.io/ipmr/">ipmr</a></span><span class="op">)</span>

<span class="co"># Define the fixed parameters in a list</span>

<span class="va">constant_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  s_int     <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>,
  s_slope   <span class="op">=</span> <span class="fl">2.2</span>,
  s_precip  <span class="op">=</span> <span class="fl">0.0002</span>,
  s_temp    <span class="op">=</span> <span class="op">-</span><span class="fl">0.003</span>,
  g_int     <span class="op">=</span> <span class="fl">0.2</span>,
  g_slope   <span class="op">=</span> <span class="fl">1.01</span>,
  g_sd      <span class="op">=</span> <span class="fl">1.2</span>,
  g_temp    <span class="op">=</span> <span class="op">-</span><span class="fl">0.002</span>,
  g_precip  <span class="op">=</span> <span class="fl">0.004</span>,
  c_r_int   <span class="op">=</span> <span class="fl">0.3</span>,
  c_r_slope <span class="op">=</span> <span class="fl">0.03</span>,
  c_s_int   <span class="op">=</span> <span class="fl">0.4</span>,
  c_s_slope <span class="op">=</span> <span class="fl">0.01</span>,
  c_d_mu    <span class="op">=</span> <span class="fl">1.1</span>,
  c_d_sd    <span class="op">=</span> <span class="fl">0.1</span>,
  r_e       <span class="op">=</span> <span class="fl">0.3</span>,
  r_d       <span class="op">=</span> <span class="fl">0.3</span>,
  r_r       <span class="op">=</span> <span class="fl">0.2</span>,
  r_s       <span class="op">=</span> <span class="fl">0.2</span>
<span class="op">)</span></code></pre></div>
<p>In addition to creating the standard <code>data_list</code>, we need to create a function to sample the environmental covariates, and a list of parameters that generate the environmental covariates. The function needs to return a named list. The names in the returned list can be referenced in vital rate expressions, kernel formulas, etc. as if we had specified them in the <code>data_list</code>. <code><a href="../reference/make_ipm.html">make_ipm()</a></code> only runs the functions in <code><a href="../reference/define_impl.html">define_env_state()</a></code> once per model iteration. This ensures that parameters from joint distributions can be used consistently across kernels without losing user-any specified correlations.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Now, we create a set of environmental covariates. In this example, we use</span>
<span class="co"># a normal distribution for temperature and a Gamma for precipitation. </span>

<span class="va">env_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  temp_mu <span class="op">=</span> <span class="fl">8.9</span>,
  temp_sd <span class="op">=</span> <span class="fl">1.2</span>,
  precip_shape <span class="op">=</span> <span class="fl">1000</span>,
  precip_rate  <span class="op">=</span> <span class="fl">2</span>
<span class="op">)</span>

<span class="co"># We define a wrapper function that samples from these distributions</span>

<span class="va">sample_env</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">env_params</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># We generate one value for each covariate per iteration, and return it </span>
  <span class="co"># as a named list. We can reference the names in this list in vital rate </span>
  <span class="co"># expressions.</span>
  
  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1</span>,
                <span class="va">env_params</span><span class="op">$</span><span class="va">temp_mu</span>, 
                <span class="va">env_params</span><span class="op">$</span><span class="va">temp_sd</span><span class="op">)</span>
  
  <span class="va">precip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span><span class="fl">1</span>, 
                   shape <span class="op">=</span> <span class="va">env_params</span><span class="op">$</span><span class="va">precip_shape</span>,
                   rate <span class="op">=</span> <span class="va">env_params</span><span class="op">$</span><span class="va">precip_rate</span><span class="op">)</span>
  
  <span class="va">out</span>        <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>temp <span class="op">=</span> <span class="va">temp</span>, precip <span class="op">=</span> <span class="va">precip</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>
  
<span class="op">}</span>


<span class="co"># Again, we can define our own functions and pass them into calls to make_ipm. This</span>
<span class="co"># isn't strictly necessary, but can make the model code more readable/less error prone.</span>

<span class="va">inv_logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lin_term</span><span class="op">)</span> <span class="op">{</span>
  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">lin_term</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="model-specification" class="section level3">
<h3 class="hasAnchor">
<a href="#model-specification" class="anchor"></a>Model specification</h3>
<p>We are now ready to begin implementing the model. This next chunk should look familiar, with the caveat that we have now add the terms <code>temp</code> and <code>precip</code> to vital rates in the <code>P</code> kernel.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">general_stoch_param_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init_ipm.html">init_ipm</a></span><span class="op">(</span>sim_gen    <span class="op">=</span> <span class="st">"general"</span>,
                                   di_dd      <span class="op">=</span> <span class="st">"di"</span>, 
                                   det_stoch  <span class="op">=</span> <span class="st">"stoch"</span>,
                                   kern_param <span class="op">=</span> <span class="st">"param"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name       <span class="op">=</span> <span class="st">"P_stoch"</span>,
    family     <span class="op">=</span> <span class="st">"CC"</span>,
    
    <span class="co"># As in the examples above, we have to add the d_surf_area</span>
    <span class="co"># to ensure the integration of the functions is done.</span>
    
    formula    <span class="op">=</span> <span class="va">s</span> <span class="op">*</span> <span class="va">g</span> <span class="op">*</span> <span class="va">d_surf_area</span>,
    
    <span class="co"># We can reference continuously varying parameters by name</span>
    <span class="co"># in the vital rate expressions just as before, even though</span>
    <span class="co"># they are passed in define_env_state() as opposed to the kernel's</span>
    <span class="co"># data_list</span>
    
    g_mu    <span class="op">=</span> <span class="va">g_int</span> <span class="op">+</span> <span class="va">g_slope</span> <span class="op">*</span> <span class="va">surf_area_1</span> <span class="op">+</span> <span class="va">g_temp</span> <span class="op">*</span> <span class="va">temp</span> <span class="op">+</span> <span class="va">g_precip</span> <span class="op">*</span> <span class="va">precip</span>,
    s_lin_p <span class="op">=</span> <span class="va">s_int</span> <span class="op">+</span> <span class="va">s_slope</span> <span class="op">*</span> <span class="va">surf_area_1</span> <span class="op">+</span> <span class="va">s_temp</span> <span class="op">*</span> <span class="va">temp</span> <span class="op">+</span> <span class="va">s_precip</span> <span class="op">*</span> <span class="va">precip</span>,
    s       <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">s_lin_p</span><span class="op">)</span>,
    g       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">surf_area_2</span>, <span class="va">g_mu</span>, <span class="va">g_sd</span><span class="op">)</span>,
   
    data_list     <span class="op">=</span> <span class="va">constant_params</span>,
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"surf_area"</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>,
    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,
    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span><span class="op">(</span><span class="st">"norm"</span>, <span class="st">"g"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name          <span class="op">=</span> <span class="st">"F"</span>,
    family        <span class="op">=</span> <span class="st">"CC"</span>,
    formula       <span class="op">=</span> <span class="va">c_r</span> <span class="op">*</span> <span class="va">c_s</span> <span class="op">*</span> <span class="va">c_d</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">r_e</span><span class="op">)</span> <span class="op">*</span> <span class="va">d_surf_area</span>,
    
    c_r_lin_p     <span class="op">=</span> <span class="va">c_r_int</span> <span class="op">+</span> <span class="va">c_r_slope</span> <span class="op">*</span> <span class="va">surf_area_1</span>,
    c_r           <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">c_r_lin_p</span><span class="op">)</span>,
    c_s           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">c_s_int</span> <span class="op">+</span> <span class="va">c_s_slope</span> <span class="op">*</span> <span class="va">surf_area_1</span><span class="op">)</span>,
    c_d           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">surf_area_2</span>, <span class="va">c_d_mu</span>, <span class="va">c_d_sd</span><span class="op">)</span>,
    data_list     <span class="op">=</span> <span class="va">constant_params</span>,
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"surf_area"</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>,
    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,
    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span><span class="op">(</span><span class="st">"norm"</span>, <span class="st">"c_d"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    
    <span class="co"># Name can be anything, but it helps to make sure they're descriptive</span>
    
    name <span class="op">=</span> <span class="st">"go_discrete"</span>,
    
    <span class="co"># Family is now "CD" because it is a continuous -&gt; discrete transition</span>
    
    family        <span class="op">=</span> <span class="st">"CD"</span>,
    formula       <span class="op">=</span> <span class="va">r_e</span> <span class="op">*</span> <span class="va">r_s</span> <span class="op">*</span> <span class="va">c_r</span> <span class="op">*</span> <span class="va">c_s</span> <span class="op">*</span> <span class="va">d_surf_area</span>,
    c_r_lin_p     <span class="op">=</span> <span class="va">c_r_int</span> <span class="op">+</span> <span class="va">c_r_slope</span> <span class="op">*</span> <span class="va">surf_area_1</span>,
    c_r           <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">c_r_lin_p</span><span class="op">)</span>,
    c_s           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">c_s_int</span> <span class="op">+</span> <span class="va">c_s_slope</span> <span class="op">*</span> <span class="va">surf_area_1</span><span class="op">)</span>,
    data_list     <span class="op">=</span> <span class="va">constant_params</span>,
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"surf_area"</span>, <span class="st">"sb"</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>,
    
    <span class="co"># There is not eviction to correct here, so we can set this to false</span>
    
    evict_cor     <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name          <span class="op">=</span> <span class="st">"stay_discrete"</span>,
    family        <span class="op">=</span> <span class="st">"DD"</span>,
    formula       <span class="op">=</span> <span class="va">r_s</span> <span class="op">*</span> <span class="va">r_r</span>,
    data_list     <span class="op">=</span> <span class="va">constant_params</span>,
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"sb"</span><span class="op">)</span>,
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>,
    evict_cor     <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name          <span class="op">=</span> <span class="st">"leave_discrete"</span>,
    family        <span class="op">=</span> <span class="st">"DC"</span>,
    formula       <span class="op">=</span> <span class="va">r_d</span> <span class="op">*</span> <span class="va">r_s</span> <span class="op">*</span> <span class="va">c_d</span> <span class="op">*</span> <span class="va">d_surf_area</span>,
    c_d           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">surf_area_2</span>, <span class="va">c_d_mu</span>, <span class="va">c_d_sd</span><span class="op">)</span>,
    data_list     <span class="op">=</span> <span class="va">constant_params</span>,
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"surf_area"</span>, <span class="st">"sb"</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>,
    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,
    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span><span class="op">(</span><span class="st">"norm"</span>, <span class="st">"c_d"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_impl</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/define_impl.html">make_impl_args_list</a></span><span class="op">(</span>
      kernel_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"P_stoch"</span>, 
                       <span class="st">"F"</span>,
                       <span class="st">"go_discrete"</span>, 
                       <span class="st">"stay_discrete"</span>, 
                       <span class="st">"leave_discrete"</span><span class="op">)</span>,
      int_rule     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"midpoint"</span>, <span class="fl">5</span><span class="op">)</span>,
      state_start  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"surf_area"</span>, 
                       <span class="st">"surf_area"</span>,
                       <span class="st">"surf_area"</span>,
                       <span class="st">"sb"</span>, 
                       <span class="st">"sb"</span><span class="op">)</span>,
      state_end    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"surf_area"</span>,
                       <span class="st">"surf_area"</span>, 
                       <span class="st">"sb"</span>, 
                       <span class="st">"sb"</span>, 
                       <span class="st">"surf_area"</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_domains</a></span><span class="op">(</span>
    surf_area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">100</span><span class="op">)</span>
  <span class="op">)</span> </code></pre></div>
<p>Now, we need to <code><a href="../reference/define_impl.html">define_env_state()</a></code>. This consists of two parts - specifying expressions that generate environmental covariates, and supplying the information needed to evaluate those expressions. In this example, we want to use the <code>env_params</code> in <code>sample_env</code> (i.e. <code>sample_env(env_params)</code>). <code>define_env_state</code> uses the <code>data_list</code> argument to supply the <code>env_params</code>, and the call to <code>sample_env</code> goes into the <code>...</code> portion of the function. Here, we assign the result to <code>env_covs</code>. The name <code>env_covs</code> isn’t important for specifying vital rate expressions and you could call it whatever you want, but it must be named something in order to work properly. The only thing that needs to match are the names in the list that <code>sample_env</code> returns, and the names used in the vital rate expressions/kernels.</p>
<p>Note that you can pass the <code>sample_env</code> function in either the <code>data_list</code> of <code><a href="../reference/define_impl.html">define_env_state()</a></code>, or the <code>usr_funs</code> argument of <code><a href="../reference/make_ipm.html">make_ipm()</a></code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># In the first version, sample_env is provided in the data_list of </span>
<span class="co"># define_env_state.</span>

<span class="va">general_stoch_param_ipm</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/define_impl.html">define_env_state</a></span><span class="op">(</span>
  proto_ipm  <span class="op">=</span> <span class="va">general_stoch_param_model</span>,
  env_covs   <span class="op">=</span> <span class="fu">sample_env</span><span class="op">(</span><span class="va">env_params</span><span class="op">)</span>,
  data_list  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>env_params <span class="op">=</span> <span class="va">env_params</span>,
                    sample_env <span class="op">=</span> <span class="va">sample_env</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/define_impl.html">define_pop_state</a></span><span class="op">(</span>
    n_surf_area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,
    n_sb        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/make_ipm.html">make_ipm</a></span><span class="op">(</span>usr_funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>inv_logit  <span class="op">=</span> <span class="va">inv_logit</span><span class="op">)</span>,
           iterate <span class="op">=</span> <span class="cn">TRUE</span>,
           iterations <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>


<span class="co"># in the second version, sample_env is provided in the usr_funs list of </span>
<span class="co"># make_ipm(). These two vesrions are equivalent. </span>

<span class="va">general_stoch_param_ipm</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/define_impl.html">define_env_state</a></span><span class="op">(</span>
  proto_ipm  <span class="op">=</span> <span class="va">general_stoch_param_model</span>,
  env_covs   <span class="op">=</span> <span class="fu">sample_env</span><span class="op">(</span><span class="va">env_params</span><span class="op">)</span>,
  data_list  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>env_params <span class="op">=</span> <span class="va">env_params</span><span class="op">)</span>
<span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/define_impl.html">define_pop_state</a></span><span class="op">(</span>
    n_surf_area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,
    n_sb        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/make_ipm.html">make_ipm</a></span><span class="op">(</span>usr_funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>inv_logit  <span class="op">=</span> <span class="va">inv_logit</span>,
                           sample_env <span class="op">=</span> <span class="va">sample_env</span><span class="op">)</span>,
           iterate <span class="op">=</span> <span class="cn">TRUE</span>,
           iterations <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></code></pre></div>
<p>Stochastic parameter-resampled models also return an <code>env_seq</code>, but this time it will be a <code>data.frame</code> of parameter draws rather than a character vector. We can also compute mean sub-kernels and <span class="math inline">\(\lambda_s\)</span> as we did in the kernel-resampled models. This time, each mean kernel is computed as the average of each sub-kernel over the course of the simulation (i.e. mean of all <code>P</code> kernels). Because the other sub-kernels are not time-varying, they will be numerically equivalent to the sub-kernels stored in the IPM object.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">env_draws</span>  <span class="op">&lt;-</span> <span class="va">general_stoch_param_ipm</span><span class="op">$</span><span class="va">env_seq</span>

<span class="va">mean_kerns</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mean_kernel.html">mean_kernel</a></span><span class="op">(</span><span class="va">general_stoch_param_ipm</span><span class="op">)</span>

<span class="va">lam_s</span>      <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lambda.html">lambda</a></span><span class="op">(</span><span class="va">general_stoch_param_ipm</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="va">mean_kerns</span><span class="op">$</span><span class="va">mean_F</span>, 
          <span class="va">general_stoch_param_ipm</span><span class="op">$</span><span class="va">sub_kernels</span><span class="op">$</span><span class="va">F_it_1</span>,
          check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="code-to-construct-mega-kernels" class="section level2">
<h2 class="hasAnchor">
<a href="#code-to-construct-mega-kernels" class="anchor"></a>Code to construct mega-kernels</h2>
<p>Sometimes, we may want to work with our sub-kernels arranged into a single block kernel. This isn’t required for any of the code in <code>ipmr</code>, except for the <code>plot</code> method for <code>general_di_det</code> IPMs. Other use cases may arise for analyses not included in this package though, so below is a brief overview of how to generate those.</p>
<p><code><a href="../reference/format_mega_matrix.html">make_iter_kernel()</a></code> takes an IPM object and a vector of symbols (for interactive use) or a character version of the expression (for programming) showing where each sub-kernel should go. It works in <strong>ROW MAJOR order</strong>. This example will use the model from the general deterministic example at the top of the article.</p>
<p>First, re-run the model to create the IPM object (if you haven’t already).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  g_int     <span class="op">=</span> <span class="fl">5.781</span>,
  g_slope   <span class="op">=</span> <span class="fl">0.988</span>,
  g_sd      <span class="op">=</span> <span class="fl">20.55699</span>,
  s_int     <span class="op">=</span> <span class="op">-</span><span class="fl">0.352</span>,
  s_slope   <span class="op">=</span> <span class="fl">0.122</span>,
  s_slope_2 <span class="op">=</span> <span class="op">-</span><span class="fl">0.000213</span>,
  r_r_int   <span class="op">=</span> <span class="op">-</span><span class="fl">11.46</span>,
  r_r_slope <span class="op">=</span> <span class="fl">0.0835</span>,
  r_s_int   <span class="op">=</span> <span class="fl">2.6204</span>,
  r_s_slope <span class="op">=</span> <span class="fl">0.01256</span>,
  r_d_mu    <span class="op">=</span> <span class="fl">5.6655</span>,
  r_d_sd    <span class="op">=</span> <span class="fl">2.0734</span>,
  e_p       <span class="op">=</span> <span class="fl">0.15</span>,
  g_i       <span class="op">=</span> <span class="fl">0.5067</span>
<span class="op">)</span>


<span class="va">L</span> <span class="op">&lt;-</span> <span class="fl">1.02</span>
<span class="va">U</span> <span class="op">&lt;-</span> <span class="fl">624</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2312</span><span class="op">)</span>

<span class="va">init_pop_vec</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span>
<span class="va">init_seed_bank</span> <span class="op">&lt;-</span> <span class="fl">20</span>

<span class="co"># Initialize the state list and add some helper functions. The survival function</span>
<span class="co"># in this model is a quadratic function.</span>

<span class="va">inv_logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span>
  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">inv_logit_2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">slope_2</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span>
  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">+</span> <span class="va">slope_2</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">general_ipm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init_ipm.html">init_ipm</a></span><span class="op">(</span>sim_gen    <span class="op">=</span> <span class="st">"general"</span>,
                        di_dd      <span class="op">=</span> <span class="st">"di"</span>, 
                        det_stoch  <span class="op">=</span> <span class="st">"det"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name          <span class="op">=</span> <span class="st">"P"</span>,
    formula       <span class="op">=</span> <span class="va">s</span> <span class="op">*</span> <span class="va">g</span> <span class="op">*</span> <span class="va">d_ht</span>,
    family        <span class="op">=</span> <span class="st">"CC"</span>,
    g             <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">g_mu</span>, <span class="va">g_sd</span><span class="op">)</span>,
    g_mu          <span class="op">=</span> <span class="va">g_int</span> <span class="op">+</span> <span class="va">g_slope</span> <span class="op">*</span> <span class="va">ht_1</span>,
    s             <span class="op">=</span> <span class="fu">inv_logit_2</span><span class="op">(</span><span class="va">s_int</span>, <span class="va">s_slope</span>, <span class="va">s_slope_2</span>, <span class="va">ht_1</span><span class="op">)</span>,
    data_list     <span class="op">=</span> <span class="va">data_list</span>,
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>,
    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,
    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,
                                            <span class="st">'g'</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name          <span class="op">=</span> <span class="st">"go_discrete"</span>,
    formula       <span class="op">=</span> <span class="va">r_r</span> <span class="op">*</span> <span class="va">r_s</span> <span class="op">*</span> <span class="va">g_i</span>,
    family        <span class="op">=</span> <span class="st">'CD'</span>,
    r_r           <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">r_r_int</span>, <span class="va">r_r_slope</span>, <span class="va">ht_1</span><span class="op">)</span>,
    r_s           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">r_s_int</span> <span class="op">+</span> <span class="va">r_s_slope</span> <span class="op">*</span> <span class="va">ht_1</span><span class="op">)</span>,
    data_list     <span class="op">=</span> <span class="va">data_list</span>,
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name      <span class="op">=</span> <span class="st">'stay_discrete'</span>,
    formula   <span class="op">=</span> <span class="fl">0</span>,
    family    <span class="op">=</span> <span class="st">"DD"</span>,  
    states    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,
    evict_cor <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name          <span class="op">=</span> <span class="st">'leave_discrete'</span>,
    formula       <span class="op">=</span> <span class="va">e_p</span> <span class="op">*</span> <span class="va">r_d</span> <span class="op">*</span> <span class="va">d_ht</span>,
    r_d           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">r_d_mu</span>, <span class="va">r_d_sd</span><span class="op">)</span>,
    family        <span class="op">=</span> <span class="st">'DC'</span>,
    data_list     <span class="op">=</span> <span class="va">data_list</span>,
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>,
    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,
    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,
                                            <span class="st">'r_d'</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_impl</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/define_impl.html">make_impl_args_list</a></span><span class="op">(</span>
      kernel_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"P"</span>, <span class="st">"go_discrete"</span>, <span class="st">"stay_discrete"</span>, <span class="st">"leave_discrete"</span><span class="op">)</span>,
      int_rule     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"midpoint"</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,
      state_start    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"ht"</span>, <span class="st">"b"</span>, <span class="st">"b"</span><span class="op">)</span>,
      state_end      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">'ht'</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_domains</a></span><span class="op">(</span>
    ht <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">L</span>, <span class="va">U</span>, <span class="va">n</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_pop_state</a></span><span class="op">(</span>
    pop_vectors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      n_ht <span class="op">=</span> <span class="va">init_pop_vec</span>,
      n_b  <span class="op">=</span> <span class="va">init_seed_bank</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/make_ipm.html">make_ipm</a></span><span class="op">(</span>iterations <span class="op">=</span> <span class="fl">100</span>,
           usr_funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>inv_logit   <span class="op">=</span> <span class="va">inv_logit</span>,
                           inv_logit_2 <span class="op">=</span> <span class="va">inv_logit_2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Now, we specify which kernel belongs where in row major order, using a call to <code><a href="https://rdrr.io/r/base/c.html">c()</a></code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mega_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_mega_matrix.html">make_iter_kernel</a></span><span class="op">(</span>ipm <span class="op">=</span> <span class="va">general_ipm</span>,
                             mega_mat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
                               <span class="va">stay_discrete</span>, <span class="va">go_discrete</span>,
                               <span class="va">leave_discrete</span>, <span class="va">P</span>
                             <span class="op">)</span><span class="op">)</span>

<span class="co"># These values should be almost identical, so this should ~0</span>

<span class="fu"><a href="https://rdrr.io/r/base/complex.html">Re</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html">eigen</a></span><span class="op">(</span><span class="va">mega_mat</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">values</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="../reference/lambda.html">lambda</a></span><span class="op">(</span><span class="va">general_ipm</span><span class="op">)</span></code></pre></div>
<p>Say we wanted to program with this function. Passing bare expression is difficult programatically, and how to do that is not really within the scope of this vignette (though if you’re interested in learning how, <a href="https://dplyr.tidyverse.org/articles/programming.html">this</a> is a good start). <code><a href="../reference/format_mega_matrix.html">make_iter_kernel()</a></code> also accepts text strings in the same format as above.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Get the names of each sub_kernel</span>
<span class="va">sub_k_nms</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">general_ipm</span><span class="op">$</span><span class="va">sub_kernels</span><span class="op">)</span>

<span class="va">mega_mat_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sub_k_nms</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">sub_k_nms</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">sub_k_nms</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="va">sub_k_nms</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>

<span class="va">mega_mat_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_mega_matrix.html">make_iter_kernel</a></span><span class="op">(</span><span class="va">general_ipm</span>,
                               mega_mat <span class="op">=</span> <span class="va">mega_mat_text</span><span class="op">)</span>

<span class="co"># Should be TRUE</span>
<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">mega_mat</span>, <span class="va">mega_mat_2</span><span class="op">)</span></code></pre></div>
<p><code><a href="../reference/format_mega_matrix.html">make_iter_kernel()</a></code> can also handle cases where you need blocks of 0s or identity matrices. These are specified using <code>0</code> for 0s, and <code>I</code> for identity matrices. <code><a href="../reference/format_mega_matrix.html">make_iter_kernel()</a></code> automatically works out the correct dimensions internally, so you don’t need to worry about specifying those.</p>
<p>Below is an example that inserts 0s and identity matrices on the off-diagonals with the <code>P</code> kernel duplicated along the diagonal.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mega_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_mega_matrix.html">make_iter_kernel</a></span><span class="op">(</span><span class="va">general_ipm</span>,
                               mega_mat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">P</span>, <span class="fl">0</span>, 
                                            <span class="va">I</span>, <span class="va">P</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Finally, <code>make_iter_kernel</code> supports <code>ipmr</code>’s suffix syntax as well, enabling us to generate lists of mega-kernels for each level of the grouping variables. We’ll re-run the <code>"general_di_stoch_kern"</code> example from above to demonstrate this.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_g_int</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, mean <span class="op">=</span> <span class="fl">5.781</span>, sd <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> 
<span class="va">all_f_s_int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, mean <span class="op">=</span> <span class="fl">2.6204</span>, sd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">all_g_int</span><span class="op">)</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"g_int_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">all_f_s_int</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"f_s_int_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>

<span class="va">constant_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  g_slope   <span class="op">=</span> <span class="fl">0.988</span>,
  g_sd      <span class="op">=</span> <span class="fl">20.55699</span>,
  s_int     <span class="op">=</span> <span class="op">-</span><span class="fl">0.352</span>,
  s_slope   <span class="op">=</span> <span class="fl">0.122</span>,
  s_slope_2 <span class="op">=</span> <span class="op">-</span><span class="fl">0.000213</span>,
  f_r_int   <span class="op">=</span> <span class="op">-</span><span class="fl">11.46</span>,
  f_r_slope <span class="op">=</span> <span class="fl">0.0835</span>,
  f_s_slope <span class="op">=</span> <span class="fl">0.01256</span>,
  f_d_mu    <span class="op">=</span> <span class="fl">5.6655</span>,
  f_d_sd    <span class="op">=</span> <span class="fl">2.0734</span>,
  e_p       <span class="op">=</span> <span class="fl">0.15</span>,
  g_i       <span class="op">=</span> <span class="fl">0.5067</span>
<span class="op">)</span>

<span class="va">all_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">constant_list</span>, <span class="va">all_g_int</span>, <span class="va">all_f_s_int</span><span class="op">)</span>

<span class="va">L</span> <span class="op">&lt;-</span> <span class="fl">1.02</span>
<span class="va">U</span> <span class="op">&lt;-</span> <span class="fl">624</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2312</span><span class="op">)</span>

<span class="va">init_pop_vec</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span>
<span class="va">init_seed_bank</span> <span class="op">&lt;-</span> <span class="fl">20</span>

<span class="va">inv_logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span>
  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">inv_logit_2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">slope_2</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span>
  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">+</span> <span class="va">slope_2</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">general_stoch_kern_ipm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init_ipm.html">init_ipm</a></span><span class="op">(</span>sim_gen    <span class="op">=</span> <span class="st">"general"</span>,
                                   di_dd      <span class="op">=</span> <span class="st">"di"</span>, 
                                   det_stoch  <span class="op">=</span> <span class="st">"stoch"</span>,
                                   kern_param <span class="op">=</span> <span class="st">"kern"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name          <span class="op">=</span> <span class="st">"P_year"</span>,
    formula       <span class="op">=</span> <span class="va">s</span> <span class="op">*</span> <span class="va">g_year</span> <span class="op">*</span> <span class="va">d_ht</span>,
    family        <span class="op">=</span> <span class="st">"CC"</span>,
    g_year           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">g_mu_year</span>, <span class="va">g_sd</span><span class="op">)</span>,
    g_mu_year        <span class="op">=</span> <span class="va">g_int_year</span> <span class="op">+</span> <span class="va">g_slope</span> <span class="op">*</span> <span class="va">ht_1</span>,
    s                <span class="op">=</span> <span class="fu">inv_logit_2</span><span class="op">(</span><span class="va">s_int</span>, <span class="va">s_slope</span>, <span class="va">s_slope_2</span>, <span class="va">ht_1</span><span class="op">)</span>,
    data_list        <span class="op">=</span> <span class="va">all_params</span>,
    states           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs    <span class="op">=</span> <span class="cn">TRUE</span>,
    levels_hier_effs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>,
    evict_cor        <span class="op">=</span> <span class="cn">TRUE</span>,
    evict_fun        <span class="op">=</span> <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,
                                               <span class="st">'g_year'</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name          <span class="op">=</span> <span class="st">"go_discrete_year"</span>,
    formula       <span class="op">=</span> <span class="va">f_r</span> <span class="op">*</span> <span class="va">f_s_year</span> <span class="op">*</span> <span class="va">g_i</span> <span class="op">*</span> <span class="va">d_ht</span>,
    family        <span class="op">=</span> <span class="st">'CD'</span>,
    f_r           <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">f_r_int</span>, <span class="va">f_r_slope</span>, <span class="va">ht_1</span><span class="op">)</span>,
    f_s_year      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">f_s_int_year</span> <span class="op">+</span> <span class="va">f_s_slope</span> <span class="op">*</span> <span class="va">ht_1</span><span class="op">)</span>,
    data_list     <span class="op">=</span> <span class="va">all_params</span>,
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs    <span class="op">=</span> <span class="cn">TRUE</span>,
    levels_hier_effs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name    <span class="op">=</span> <span class="st">'stay_discrete'</span>,
    formula <span class="op">=</span> <span class="fl">0</span>,
    family  <span class="op">=</span> <span class="st">"DD"</span>,
    states  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'b'</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>,
    evict_cor <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_kernel.html">define_kernel</a></span><span class="op">(</span>
    name          <span class="op">=</span> <span class="st">'leave_discrete'</span>,
    formula       <span class="op">=</span> <span class="va">e_p</span> <span class="op">*</span> <span class="va">f_d</span> <span class="op">*</span> <span class="va">d_ht</span>,
    f_d           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">f_d_mu</span>, <span class="va">f_d_sd</span><span class="op">)</span>,
    family        <span class="op">=</span> <span class="st">'DC'</span>,
    data_list     <span class="op">=</span> <span class="va">all_params</span>,
    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,
    has_hier_effs <span class="op">=</span> <span class="cn">FALSE</span>,
    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,
    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/truncated_distributions.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,
                                            <span class="st">'f_d'</span><span class="op">)</span>
  <span class="op">)</span>  <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_impl</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/define_impl.html">make_impl_args_list</a></span><span class="op">(</span>
      kernel_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"P_year"</span>, <span class="st">"go_discrete_year"</span>, <span class="st">"stay_discrete"</span>, <span class="st">"leave_discrete"</span><span class="op">)</span>,
      int_rule     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"midpoint"</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,
      state_start    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"ht"</span>, <span class="st">"b"</span>, <span class="st">"b"</span><span class="op">)</span>,
      state_end      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">'ht'</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_domains</a></span><span class="op">(</span>
    ht <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">L</span>, <span class="va">U</span>, <span class="va">n</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/define_impl.html">define_pop_state</a></span><span class="op">(</span>
      n_ht <span class="op">=</span> <span class="va">init_pop_vec</span>,
      n_b  <span class="op">=</span> <span class="va">init_seed_bank</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/make_ipm.html">make_ipm</a></span><span class="op">(</span>
    iterations <span class="op">=</span> <span class="fl">10</span>,
    kernel_seq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, size <span class="op">=</span> <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    usr_funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>inv_logit   <span class="op">=</span> <span class="va">inv_logit</span>,
                    inv_logit_2 <span class="op">=</span> <span class="va">inv_logit_2</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p>Next, we call <code><a href="../reference/format_mega_matrix.html">make_iter_kernel()</a></code> using the kernel names like so:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">block_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/format_mega_matrix.html">make_iter_kernel</a></span><span class="op">(</span><span class="va">general_stoch_kern_ipm</span>,
                                 mega_mat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">stay_discrete</span>, <span class="va">go_discrete_year</span>,
                                              <span class="va">leave_discrete</span>, <span class="va">P_year</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><code><a href="../reference/format_mega_matrix.html">make_iter_kernel()</a></code> also works for simple models, but assumes that all sub-kernels are combined additively (i.e. <span class="math inline">\(K(z',z) = P(z',z) + F('z,z)\)</span>). It can handle suffix syntax as well, but does not require the <code>mega_mat</code> argument, and can just be called with an IPM object.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/levisc8">Sam Levin</a>, Aldo Compagnoni, Dylan Childs, Sanne Evers, Roberto Salguero-Gomez, Tiffany Knight.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
